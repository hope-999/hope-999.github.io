[{"title":"No.150-fastapiä¸­å¼‚æ­¥å‡½æ•°æ€ä¹ˆæµ‹è¯•","url":"/2025/08/09/No-150-fastapi%E4%B8%AD%E5%BC%82%E6%AD%A5%E5%87%BD%E6%95%B0%E6%80%8E%E4%B9%88%E6%B5%8B%E8%AF%95/","content":"å¯¼è¯»åœ¨ fastapi ä¸­ï¼Œç»å¸¸ä¼šæœ‰å¼‚æ­¥å‡½æ•°ï¼Œé‚£ä¹ˆåœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œæ€ä¹ˆæµ‹è¯•å¼‚æ­¥å‡½æ•°å‘¢ï¼Ÿ\néœ€è¦ä½¿ç”¨ä¸“é—¨çš„å·¥å…·å’Œæ–¹æ³•ã€‚pytest é€šè¿‡ pytest-asyncio æ’ä»¶æä¾›äº†å¯¹å¼‚æ­¥æµ‹è¯•çš„æ”¯æŒã€‚\nå®‰è£…å¿…è¦çš„åŒ…é¦–å…ˆéœ€è¦å®‰è£… pytest å’Œ pytest-asyncioï¼š\npip install pytest pytest-asyncio\n\nåŸºæœ¬å¼‚æ­¥æµ‹è¯•1. ç®€å•å¼‚æ­¥æµ‹è¯•import pytestasync def async_function():    return 42@pytest.mark.asyncioasync def test_async_function():    result = await async_function()    assert result == 42\n\n2. æµ‹è¯•å¼‚æ­¥ HTTP è¯·æ±‚import pytestimport aiohttp@pytest.mark.asyncioasync def test_http_request():    async with aiohttp.ClientSession() as session:        async with session.get(&#x27;https://httpbin.org/get&#x27;) as resp:            assert resp.status == 200            data = await resp.json()            assert &#x27;url&#x27; in data\n\né«˜çº§ç”¨æ³•1. ä½¿ç”¨å¼‚æ­¥ fixtureimport pytest@pytest.fixtureasync def async_fixture():    # å¼‚æ­¥è®¾ç½®ä»£ç     yield &quot;fixture value&quot;    # å¼‚æ­¥æ¸…ç†ä»£ç @pytest.mark.asyncioasync def test_with_async_fixture(async_fixture):    assert async_fixture == &quot;fixture value&quot;\n\n2. æµ‹è¯•è¶…æ—¶import pytestimport asyncioasync def slow_operation():    await asyncio.sleep(2)    return &quot;done&quot;@pytest.mark.asyncioasync def test_slow_operation():    with pytest.raises(asyncio.TimeoutError):        await asyncio.wait_for(slow_operation(), timeout=0.1)\n\n3. æµ‹è¯•å¼‚æ­¥å¼‚å¸¸import pytestasync def async_raise_exception():    raise ValueError(&quot;Something went wrong&quot;)@pytest.mark.asyncioasync def test_async_exception():    with pytest.raises(ValueError, match=&quot;Something went wrong&quot;):        await async_raise_exception()\n\né…ç½® pytest-asyncioå¯ä»¥åœ¨ pytest.ini ä¸­é…ç½® pytest-asyncioï¼š\n[pytest]asyncio_mode = auto\n\nå¯é€‰æ¨¡å¼ï¼š\n\nstrict - åªè¿è¡Œæ ‡è®°ä¸º @pytest.mark.asyncio çš„æµ‹è¯•\nauto - è‡ªåŠ¨æ£€æµ‹å¼‚æ­¥æµ‹è¯•å‡½æ•°\nlegacy - æ—§ç‰ˆè¡Œä¸º\n\næ³¨æ„äº‹é¡¹\nç¡®ä¿æµ‹è¯•å‡½æ•°è¢« @pytest.mark.asyncio è£…é¥°\nä¸è¦åœ¨åŒæ­¥å‡½æ•°ä¸­ä½¿ç”¨ awaitï¼Œè¿™ä¼šå¯¼è‡´è¯­æ³•é”™è¯¯\nå¯¹äºå¤æ‚çš„å¼‚æ­¥æµ‹è¯•ï¼Œè€ƒè™‘ä½¿ç”¨ asyncio çš„äº‹ä»¶å¾ªç¯æ§åˆ¶\næµ‹è¯•æ•°æ®åº“æ“ä½œæ—¶ï¼Œç¡®ä¿ä½¿ç”¨æ”¯æŒå¼‚æ­¥çš„æ•°æ®åº“é©±åŠ¨\n\nå®Œæ•´ç¤ºä¾‹# my_async_module.pyasync def fetch_data(db):    await db.connect()    data = await db.query(&quot;SELECT * FROM table&quot;)    return data# test_my_async_module.pyimport pytestfrom unittest.mock import AsyncMockfrom my_async_module import fetch_data@pytest.mark.asyncioasync def test_fetch_data():    # åˆ›å»ºå¼‚æ­¥mockå¯¹è±¡    mock_db = AsyncMock()    mock_db.query.return_value = [1, 2, 3]        result = await fetch_data(mock_db)        assert result == [1, 2, 3]    mock_db.connect.assert_awaited_once()    mock_db.query.assert_awaited_once_with(&quot;SELECT * FROM table&quot;)\n\né€šè¿‡ä»¥ä¸Šæ–¹æ³•ï¼Œä½ å¯ä»¥æœ‰æ•ˆåœ°æµ‹è¯• Python ä¸­çš„å¼‚æ­¥ä»£ç ã€‚\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.147-Pythonç”Ÿæˆä¸é‡å¤çš„åˆ†æ”¯å","url":"/2025/08/14/No-147-Python%E7%94%9F%E6%88%90%E4%B8%8D%E9%87%8D%E5%A4%8D%E7%9A%84%E5%88%86%E6%94%AF%E5%90%8D/","content":"å¯¼è¯»åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸é‡åˆ°ä¸€äº›åç§°éœ€è¦è‡ªåŠ¨åŒ–ç”Ÿæˆï¼Œå¹¶ä¸”åç§°è¦æ±‚å”¯ä¸€æ€§ã€‚è¿™å°±è¦æ±‚åç§°éšæ—¶ç”Ÿæˆï¼Œå¹¶ä¸”è·Ÿå‰é¢çš„åç§°ä¸é‡å¤ã€‚\nä¾‹å¦‚ï¼šä»»åŠ¡idã€åˆ†æ”¯id ç­‰\né¡¹ç›®å¼€å‘ä¸­å®é™…ä¸Šç”¨åˆ°äº†ç”Ÿæˆåˆ†æ”¯åç§°çš„åœºæ™¯ã€‚\nä»‹ç»å››ç§æ–¹æ³•æ–¹æ³•1: ä½¿ç”¨æ—¶é—´æˆ³ + éšæœºå­—ç¬¦ä¸²ï¼ˆæ¨èï¼‰import timeimport randomimport stringdef generate_branch_name(prefix=&quot;feature&quot;):    timestamp = int(time.time() * 1000)    random_str = &#x27;&#x27;.join(random.choices(string.ascii_lowercase + string.digits, k=4))    return f&quot;&#123;prefix&#125;-&#123;timestamp&#125;-&#123;random_str&#125;&quot;# ç¤ºä¾‹ä½¿ç”¨print(generate_branch_name())  # ä¾‹å¦‚: feature-1751283975396-ab3dprint(generate_branch_name(&quot;bugfix&quot;))  # ä¾‹å¦‚: bugfix-1751283983855-c4e2\n\nè¿™ç§æ–¹æ³•å”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯ï¼šå¹¶å‘éå¸¸é«˜çš„æ—¶å€™ï¼Œä¼šé‡å¤ã€‚ä¸€èˆ¬æƒ…å†µä¸‹è¶³å¤Ÿäº†ã€‚\næ–¹æ³•2: ä½¿ç”¨UUIDï¼ˆæ¨èï¼‰import uuiddef generate_branch_name(prefix=&quot;feature&quot;):    unique_id = str(uuid.uuid4())    return f&quot;&#123;prefix&#125;-&#123;unique_id&#125;&quot;# ç¤ºä¾‹ä½¿ç”¨print(generate_branch_name())  # ä¾‹å¦‚: feature-65317f15-65a8-47ea-8b5b-380c738015e0\n\nè¿™ç§æ–¹å¼ä¼šé‡å¤å—ï¼Ÿ\nUUID v4ç”Ÿæˆè§„åˆ™ï¼šåŸºäºéšæœºæ•°ç”Ÿæˆã€‚\né‡å¤æ¦‚ç‡ï¼šçº¦ 1&#x2F;2^122ï¼ˆå³çº¦ 5.3Ã—10â»Â³â¶ï¼‰ã€‚\nä¸¾ä¾‹ï¼šæ¯ç§’ç”Ÿæˆ 10 äº¿ä¸ª UUIDï¼ŒæŒç»­çº¦ 85 å¹´ æ‰æœ‰ 50% çš„æ¦‚ç‡å‘ç”Ÿä¸€æ¬¡é‡å¤ã€‚\næ‰€ä»¥é‡å¤çš„æ¦‚ç‡æä½ã€‚\næ–¹æ³•3: åŸºäºç”¨æˆ·å’Œé¡¹ç›®ä¿¡æ¯ï¼ˆæ¨èï¼‰import getpassimport timeimport hashlibdef generate_branch_name(prefix=&quot;feature&quot;, project_name=None):    user = getpass.getuser()    timestamp = int(time.time())        if project_name:        base_str = f&quot;&#123;user&#125;-&#123;project_name&#125;-&#123;timestamp&#125;&quot;    else:        base_str = f&quot;&#123;user&#125;-&#123;timestamp&#125;&quot;        # ä½¿ç”¨hashç¼©çŸ­    hash_str = hashlib.md5(base_str.encode()).hexdigest()    return f&quot;&#123;prefix&#125;-&#123;hash_str&#125;&quot;# ç¤ºä¾‹ä½¿ç”¨print(generate_branch_name())  # ä¾‹å¦‚: feature-81bbf63af6cba2da8541d72c8c02fd60print(generate_branch_name(project_name=&quot;myproject&quot;))  # ä¾‹å¦‚: feature-ba34657bd9983d679d00a7d991d333ba\n\næ–¹æ³•4: ä½¿ç”¨é€’å¢è®¡æ•°å™¨ï¼ˆéœ€è¦å­˜å‚¨ï¼‰(ä¸æ¨è)import osdef generate_branch_name(prefix=&quot;feature&quot;):    counter_file = &quot;.branch_counter&quot;        # è¯»å–æˆ–åˆå§‹åŒ–è®¡æ•°å™¨    if os.path.exists(counter_file):        with open(counter_file, &quot;r&quot;) as f:            counter = int(f.read()) + 1    else:        counter = 1        # ä¿å­˜æ–°è®¡æ•°å™¨å€¼    with open(counter_file, &quot;w&quot;) as f:        f.write(str(counter))        return f&quot;&#123;prefix&#125;-&#123;counter:04d&#125;&quot;# ç¤ºä¾‹ä½¿ç”¨print(generate_branch_name())  # ä¾‹å¦‚: feature-0001, feature-0002 ç­‰\n\nè¿™ç§æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œé€‚åˆå¹¶å‘ä¸é«˜çš„åœºæ™¯ï¼Œä¸€èˆ¬ä¸æ¨èã€‚\né€‰æ‹©å“ªç§æ–¹æ³•å–å†³äºä½ çš„å…·ä½“éœ€æ±‚ï¼š\n\nå¦‚æœåªéœ€è¦ç®€å•å”¯ä¸€æ€§ï¼Œæ–¹æ³•1æˆ–2è¶³å¤Ÿ\nå¦‚æœéœ€è¦å¯è¯»æ€§ï¼Œæ–¹æ³•3ä¸é”™\nå¦‚æœéœ€è¦é¡ºåºç¼–å·ï¼Œä½¿ç”¨æ–¹æ³•4\n\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.149-fastapiä¸­æ¨¡å‹è½¬jsonå­—ç¬¦ä¸²çš„å‘","url":"/2025/08/08/No-149-fastapi%E4%B8%AD%E6%A8%A1%E5%9E%8B%E8%BD%ACjson%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E5%9D%91/","content":"å¯¼è¯»åœ¨ fastapi ä¸­ï¼Œä½¿ç”¨pydanticå®šä¹‰æ¨¡å‹æ˜¯éå¸¸ç®€å•çš„äº‹æƒ…ï¼Œå¯ä»¥è®©ä»£ç å˜å¾—å¯è¯»æ€§æ›´å¼ºã€‚\nåœ¨ä½¿ç”¨çš„æ—¶å€™ç»å¸¸é‡åˆ° æ¨¡å‹ -&gt; json json -&gt; æ¨¡å‹ ä¹‹é—´çš„è½¬æ¢ã€‚\nåœ¨è½¬æ¢çš„æ—¶å€™é‡åˆ°æ€»æŠ¥é”™ï¼Œé‚è®°å½•ä¸€ä¸‹ï¼Œè°¨è®°åœ¨å¿ƒã€‚\næ¨¡å‹-&gt;jsonæŠ¥é”™å¼‚å¸¸å…ˆå†™ä¸€æ®µæ­£å¸¸æƒ…å†µçš„æµ‹è¯•ä»£ç ï¼Œæµ‹è¯•å·¥å…·ä½¿ç”¨pytestï¼š\nfrom sqlmodel import Session, selectfrom app.core.db import db_enginefrom app.models.sqlmodel_table import EnvModeldef test_env_model():    with Session(db_engine) as session:        query = select(EnvModel).where(EnvModel.is_delete == 0)        result = session.exec(query).all()        print(result)\n\næµ‹è¯•ç»“æœï¼š\n$ pytest -sv app/tests/scripts_service/env_model_test.pyapp/tests/scripts_service/env_model_test.py::test_env_model [EnvModel(case_env_id=&#x27;T12&#x27;, id=1, is_delete=0, updated_at=datetime.datetime(2025, 7, 10, 14, 42, 17), app_id=&#x27;&#x27;, case_env=&#x27;***å†…ç°&#x27;, created_at=datetime.datetime(2025, 710, 14, 42, 17)), EnvModel(case_env_id=&#x27;T1760&#x27;, id=2, is_delete=0, updated_at=datetime.datetime(2025, 7, 10, 20, 3, 44), app_id=&#x27;app123456789abc&#x27;, case_env=&#x27;æµ‹è¯•ç¯å¢ƒ&#x27;, created_at=datetime.datetime(200, 14, 42, 17))]PASSED\n\næ¨¡å‹è½¬jsoné”™è¯¯ç”¨æ³•1ï¼šä½¿ç”¨ list ç±»å‹è¿›è¡Œè½¬æ¢:\ndef test_env_model():    with Session(db_engine) as session:        query = select(EnvModel).where(EnvModel.is_delete == 0)        result = session.exec(query).all()        print(result.model_dump())\n\næµ‹è¯•ç»“æœï¼š\n$ pytest -sv app/tests/scripts_service/env_model_test.pyFAILED app/tests/scripts_service/env_model_test.py::test_env_model - AttributeError: &#x27;list&#x27; object has no attribute &#x27;model_dump&#x27;\n\næ­£ç¡®åº”è¯¥ä½¿ç”¨æ¨¡å‹å…ƒç´ ï¼Œè€Œéåˆ—è¡¨ï¼š\ndef test_env_model():    with Session(db_engine) as session:        query = select(EnvModel).where(EnvModel.is_delete == 0)        result = session.exec(query).all()        for i in result:            print(i.model_dump())\n\næµ‹è¯•ç»“æœï¼š\n$ pytest -sv app/tests/scripts_service/env_model_test.pyapp/tests/scripts_service/env_model_test.py::test_env_model &#123;&#x27;case_env_id&#x27;: &#x27;T12&#x27;, &#x27;is_delete&#x27;: 0, &#x27;case_env&#x27;: &#x27;***å†…ç°&#x27;, &#x27;updated_at&#x27;: datetime.datetime(2025, 7, 10, 14, 42, 17), &#x27;id&#x27;: 1, &#x27;app_id&#x27;: &#x27;&#x27;, &#x27;created_at&#x27;: datetime.dateme(2025, 7, 10, 14, 42, 17)&#125;&#123;&#x27;case_env_id&#x27;: &#x27;T1760&#x27;, &#x27;is_delete&#x27;: 0, &#x27;case_env&#x27;: &#x27;æµ‹è¯•ç¯å¢ƒ&#x27;, &#x27;updated_at&#x27;: datetime.datetime(2025, 7, 10, 20, 3, 44), &#x27;id&#x27;: 2, &#x27;app_id&#x27;: &#x27;app123456789abc&#x27;, &#x27;created_at&#x27;: datetime.datetime(2025, 7, 42, 17)&#125;PASSED\n\nå¯ä»¥çœ‹åˆ°ï¼Œè¢«è½¬æ¢æˆdictç±»å‹äº†ï¼Œä½†æ˜¯æ—¥æœŸå­—æ®µè¿˜æ˜¯pythonç±»å‹ã€‚\næ‰“å¼€model_dump()æ–¹æ³•çš„æºç çœ‹ä¸‹ï¼š\ndef model_dump(    self,    *,    mode: Union[Literal[&quot;json&quot;, &quot;python&quot;], str] = &quot;python&quot;,    include: Union[IncEx, None] = None,    exclude: Union[IncEx, None] = None,    context: Union[Dict[str, Any], None] = None,    by_alias: bool = False,    exclude_unset: bool = False,    exclude_defaults: bool = False,    exclude_none: bool = False,    round_trip: bool = False,    warnings: Union[bool, Literal[&quot;none&quot;, &quot;warn&quot;, &quot;error&quot;]] = True,    serialize_as_any: bool = False,) -&gt; Dict[str, Any]:    if PYDANTIC_MINOR_VERSION &gt;= (2, 7):        extra_kwargs: Dict[str, Any] = &#123;            &quot;context&quot;: context,            &quot;serialize_as_any&quot;: serialize_as_any,        &#125;    else:        extra_kwargs = &#123;&#125;    if IS_PYDANTIC_V2:        return super().model_dump(            mode=mode,            include=include,            exclude=exclude,            by_alias=by_alias,            exclude_unset=exclude_unset,            exclude_defaults=exclude_defaults,            exclude_none=exclude_none,            round_trip=round_trip,            warnings=warnings,            **extra_kwargs,        )    else:        return super().dict(            include=include,            exclude=exclude,            by_alias=by_alias,            exclude_unset=exclude_unset,            exclude_defaults=exclude_defaults,            exclude_none=exclude_none,        )\n\nå¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤çš„æ¨¡å¼å°±æ˜¯ pythonã€‚\nå½“æˆ‘ä»¬æŠŠ mode èµ‹å€¼æˆ json çœ‹çœ‹ã€‚\ndef test_env_model():    with Session(db_engine) as session:        query = select(EnvModel).where(EnvModel.is_delete == 0)        result = session.exec(query).all()        for i in result:            print(i.model_dump(mode=&quot;json&quot;))\n\næµ‹è¯•ç»“æœï¼š\n$ pytest -sv app/tests/scripts_service/env_model_test.pyapp/tests/scripts_service/env_model_test.py::test_env_model &#123;&#x27;case_env_id&#x27;: &#x27;T12&#x27;, &#x27;is_delete&#x27;: 0, &#x27;id&#x27;: 1, &#x27;updated_at&#x27;: &#x27;2025-07-10T14:42:17&#x27;, &#x27;app_id&#x27;: &#x27;&#x27;, &#x27;case_env&#x27;: &#x27;***å†…ç°&#x27;, &#x27;created_at&#x27;: &#x27;2025-07-10T14:42:17&#x27;&#125;&#123;&#x27;case_env_id&#x27;: &#x27;T1760&#x27;, &#x27;is_delete&#x27;: 0, &#x27;id&#x27;: 2, &#x27;updated_at&#x27;: &#x27;2025-07-10T20:03:44&#x27;, &#x27;app_id&#x27;: &#x27;app123456789abc&#x27;, &#x27;case_env&#x27;: &#x27;æµ‹è¯•ç¯å¢ƒ&#x27;, &#x27;created_at&#x27;: &#x27;2025-07-10T14:42:17&#x27;&#125;PASSED\n\nè¿™ä¸‹å°±æ˜¯æ¯”è¾ƒæ­£å¸¸çš„æ•°æ®äº†ã€‚\næ€»ç»“å½“ä½¿ç”¨ model_dump() è¿›è¡Œæ¨¡å‹è½¬æ¢æ—¶éœ€è¦æ³¨æ„ï¼š\n\nè¦è½¬æ¢çš„ç±»å‹éœ€è¦æ˜¯æ¨¡å‹å®ä¾‹ï¼Œè€Œé list\néœ€è¦æŒ‡å®š mode=&quot;json&quot;ï¼Œå¦åˆ™æ—¥æœŸæ ¼å¼æ— æ³•æ­£ç¡®è½¬æ¢\n\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.148-fastapiä¸­ä½¿ç”¨æ ‡å‡†åŒ–å‡ºå…¥å‚è‡ªåŠ¨åŒ–ç”Ÿæˆæ¥å£æ–‡æ¡£","url":"/2025/08/07/No-148-fastapi%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%A0%87%E5%87%86%E5%8C%96%E5%87%BA%E5%85%A5%E5%8F%82%E8%87%AA%E5%8A%A8%E5%8C%96%E7%94%9F%E6%88%90%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3/","content":"å¯¼è¯»åœ¨ fastapi ä¸­ï¼Œè‡ªåŠ¨åŒ–ç”Ÿæˆæ–‡æ¡£æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„äº‹æƒ…ã€‚\nä½†æ˜¯ä¹Ÿéœ€è¦éµå¾ªä¸€äº›éå¸¸å¿…è¦çš„è§„åˆ™æ¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç”Ÿæˆä¾¿äºé˜…è¯»çš„æ–‡æ¡£ã€‚\nè¿™ç¯‡æ–‡ç« å°†ä»‹ç»ä»å…¥å‚çš„å®šä¹‰ã€åˆ°è¿”å›ç»“æ„ä½“çš„å®šä¹‰ï¼Œå¼‚å¸¸æ•è·å‡ ä¸ªæ–¹é¢æ¥è§„èŒƒæ¥å£å¼€å‘æ–‡æ¡£ã€‚\nä½¿ç”¨çš„å‚æ•°æ ¡éªŒåº“ä¸ºï¼špydanticã€‚\nå…¥å‚çš„å®šä¹‰å¿…å¡«å‚æ•°from typing import Optional, List, Literal, Unionfrom pydantic import BaseModel, Fieldclass RemoveModuleRequest(BaseModel):    service_id: int = Field(..., description=&quot;æœåŠ¡ id&quot;)\n\nè¯´æ˜ï¼š\n\nå®šä¹‰ class ç±»\nç»§æ‰¿ BaseModel\nä½¿ç”¨ Field å®šä¹‰å‚æ•°ç±»å‹ç­‰ã€‚\nè¿™é‡Œå®šä¹‰äº†service_idå­—æ®µä¸ºintç±»å‹\nField ç¬¬ä¸€ä¸ªå‚æ•°çš„é»˜è®¤å€¼ä¸º ...ï¼Œå°±è¡¨ç¤ºæ˜¯å¿…å¡«å‚æ•°\n\néå¿…å¡«å‚æ•°from typing import Optional, List, Literal, Unionfrom pydantic import BaseModel, Fieldclass ModuleCaseManagerCaseListRequest(BaseModel):    order_id: Optional[int] = Field(default=None, description=&quot;å·¥å•id&quot;)\n\nè¯´æ˜ï¼š\n\nè¿™é‡Œå®šä¹‰äº†order_idå­—æ®µä¸ºintç±»å‹\nä½¿ç”¨ Optional åŒ…è£¹ä½ int è¡¨ç¤ºéå¿…å¡«\nç»“åˆField ç¬¬ä¸€ä¸ªå‚æ•°çš„é»˜è®¤å€¼ä¸º default=Noneï¼Œå°±è¡¨ç¤ºæ˜¯éå¿…å¡«å‚æ•°\n\næ³¨æ„ï¼šè¿™é‡Œçš„ default=None ä¸èƒ½ç®€å†™æˆ Noneï¼Œç®€å†™ä¹‹åæ–‡æ¡£å°†è¯†åˆ«ä¸äº†ï¼Œä¸çŸ¥é“è¿™ä¸ªé—®é¢˜ fastapi å®˜æ–¹ä¿®å¤äº†æ²¡ã€‚\nå­—ç¬¦ä¸²å‚æ•°é•¿åº¦å®šä¹‰from typing import Optional, List, Literal, Unionfrom pydantic import BaseModel, Fieldclass ModuleCaseManagerCaseListRequest(BaseModel):    env_id: Optional[str] = Field(default=None, max_length=8, min_length=4, description=&quot;å·¥å•id&quot;)\n\nè¯´æ˜ï¼š\n\nè¿™é‡Œå®šä¹‰äº†env_idå­—æ®µä¸ºstrç±»å‹\nä½¿ç”¨ Optional åŒ…è£¹ä½ str è¡¨ç¤ºéå¿…å¡«\nç»“åˆField ç¬¬ä¸€ä¸ªå‚æ•°çš„é»˜è®¤å€¼ä¸º default=Noneï¼Œå°±è¡¨ç¤ºæ˜¯éå¿…å¡«å‚æ•°\nmax_length å®šä¹‰å­—æ®µæœ€é•¿ä¸º 8 ä¸ªå­—ç¬¦\nmin_length å®šä¹‰å­—æ®µæœ€çŸ­ä¸º 4 ä¸ªå­—ç¬¦\n\nå‚æ•°å¯é€‰å€¼class RequestEnv(BaseModel):    env: Literal[&quot;dev&quot;, &quot;test&quot;, &quot;pro&quot;] = Field(        ..., description=&quot;ç¯å¢ƒ: dev-å¼€å‘, test-æµ‹è¯•, pro-ç°ç½‘&quot;    )\n\nè¯´æ˜ï¼š\n\nLiteral[&quot;dev&quot;, &quot;test&quot;, &quot;pro&quot;] å®šä¹‰å¯é€‰å€¼\n\nåµŒå¥—å‚æ•°ä»¥ä¸Šå¤„ç†çš„éƒ½æ˜¯å±‚çº§æ¯”è¾ƒå•ä¸€çš„å…¥å‚ä¾‹å¦‚æ ¼å¼è¿™æ ·çš„:\n &#123;    &quot;service&quot;: &quot;&quot;,    &quot;plan_id&quot;: &quot;0&quot;,    &quot;order_id&quot;: &quot;0&quot;,    &quot;env_id&quot;: &quot;&quot;&#125;\n\nå¦‚æœè¦å¤„ç†å¤šä¸ªå±‚çº§çš„å…¥å‚ï¼Œä¾‹å¦‚è¿™æ ·çš„å‚æ•°æ€ä¹ˆå¤„ç†:\n  &#123;    &quot;services&quot;: [&#123;        &quot;service_type&quot;: &quot;&quot;,        &quot;service_info_id&quot;: 0,        &quot;branch_id&quot;: 0,        &quot;api_ids&quot;: [101, 201, 345]    &#125;],    &quot;plan_id&quot;: &quot;0&quot;,    &quot;order_id&quot;: &quot;0&quot;,    &quot;env_id&quot;: &quot;&quot;&#125;\n\n åªéœ€è¦å†å®šä¹‰ä¸€ä¸ªæ¨¡å‹ï¼Œè¿›è¡ŒåµŒå¥—å³å¯ï¼š\n class ApiCaseManagerRunCaseServiceData(BaseModel):    service_type: str = Field(..., description=&quot;æœåŠ¡ç±»å‹&quot;)    service_info_id: int = Field(..., description=&quot;æœåŠ¡id&quot;)    branch_id: int = Field(..., description=&quot;åˆ†æ”¯id&quot;)    api_ids: list = Field(..., description=&quot;æ¥å£idåˆ—è¡¨&quot;, example=[101, 201, 345])class ApiCaseManagerRunCaseRequest(BaseModel):    services: List[ApiCaseManagerRunCaseServiceData] = Field(..., description=&quot;æœåŠ¡åˆ—è¡¨&quot;) # è¿™é‡ŒåµŒå¥—æ¨¡å‹    plan_id: Optional[int] = Field(default=0, description=&quot;è®¡åˆ’ IDï¼Œå…³è”ä¸šåŠ¡è®¡åˆ’çš„æ ‡è¯†&quot;)    order_id: Optional[int] = Field(default=0, description=&quot;å·¥å•id&quot;)    env_id: str = Field(..., description=&quot;ç¯å¢ƒid&quot;)\n\nè¿”å›ç»“æ„ä½“å®šä¹‰åŸºç¡€ç»“æ„ä½“çš„å®šä¹‰T = TypeVar(&quot;T&quot;)  # æ³›å‹ç±»å‹å˜é‡ï¼Œç”¨äºdataå­—æ®µclass BaseResponse(BaseModel, Generic[T]):    &quot;&quot;&quot;    åŸºç¡€å“åº”æ¨¡å‹ï¼Œæ‰€æœ‰APIå“åº”éƒ½åº”ç»§æ‰¿æ­¤æ¨¡å‹    &quot;&quot;&quot;    code: int = Field(default=0, description=&quot;çŠ¶æ€ç ï¼Œ0è¡¨ç¤ºæˆåŠŸï¼Œé0è¡¨ç¤ºé”™è¯¯&quot;, example=0)    rec_ts: float = Field(        ...,        description=&quot;è¯·æ±‚æ¥æ”¶æ—¶é—´æˆ³ï¼ˆUnixæ—¶é—´æˆ³ï¼Œç²¾ç¡®åˆ°æ¯«ç§’ï¼‰&quot;,        example=1611399999.999999,    )    rsp_ts: float = Field(        ...,        description=&quot;å“åº”ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆUnixæ—¶é—´æˆ³ï¼Œç²¾ç¡®åˆ°æ¯«ç§’ï¼‰&quot;,        example=1611399999.999999,    )    msg: str = Field(        default=&quot;success&quot;,        description=&quot;çŠ¶æ€æ¶ˆæ¯ï¼ŒæˆåŠŸæ—¶ä¸º&#x27;success&#x27;ï¼Œé”™è¯¯æ—¶ä¸ºé”™è¯¯æè¿°&quot;,        example=&quot;success&quot;,    )    data: Optional[T] = Field(default=None, description=&quot;å®é™…è¿”å›çš„æ•°æ®å†…å®¹ï¼Œé”™è¯¯æ—¶ä¸ºnull&quot;)    @classmethod    def success(cls, data: T = None, msg: str = &quot;success&quot;):        &quot;&quot;&quot;æˆåŠŸçš„å¿«æ·æ–¹æ³•&quot;&quot;&quot;        now = datetime.now().timestamp()        return cls(code=0, rec_ts=now, rsp_ts=now, msg=msg, data=data)\n\nå®šä¹‰è¦è¿”å›çš„æ•°æ®æ¨¡å‹class PeopleDataModel(BaseModel):    numbers: List[int]    people: List[str]class PeopleDataModelResponse(BaseResponse[PeopleDataModel]):    pass\n\nè·¯ç”±å‡½æ•°ä¸­ä½¿ç”¨@router.post(&quot;/case_list/1.0.0&quot;, response_model=PeopleDataModelResponse, name=&quot;ç”¨ä¾‹åˆ—è¡¨&quot;)def case_list(    db_session: DbSessionDep    request: ApiCaseManagerCaseListRequest) -&gt; Any:    &quot;&quot;&quot;ç”¨ä¾‹åˆ—è¡¨    Args:        db_session: æ•°æ®åº“è¿æ¥        request: è¯·æ±‚å‚æ•°    Returns:        Any    &quot;&quot;&quot;    # è·å–æŸ¥è¯¢ç»“æœï¼ˆåˆ—è¡¨ï¼‰    data = case_list_crud(request, db_session)    return PeopleDataModelResponse.success(data=data)\n\nè¿”å›æ•°æ®æ ¼å¼ç¤ºä¾‹&#123;  &quot;code&quot;: 0,  &quot;rec_ts&quot;: 1611399999.999999,  &quot;rsp_ts&quot;: 1611399999.999999,  &quot;msg&quot;: &quot;success&quot;,  &quot;data&quot;:&#123;      &quot;numbers&quot;: 0,      &quot;people&quot;: &quot; å°æ˜&quot;    &#125;&#125;\n\nä¹Ÿå¯ä»¥ä¸ç”¨å®šä¹‰PeopleDataModelResponse@router.post(&quot;/case_list/1.0.0&quot;, response_model=BaseResponse[PeopleDataModel], name=&quot;ç”¨ä¾‹åˆ—è¡¨&quot;)def case_list(    db_session: DbSessionDep    request: ApiCaseManagerCaseListRequest) -&gt; Any:    &quot;&quot;&quot;ç”¨ä¾‹åˆ—è¡¨    Args:        db_session: æ•°æ®åº“è¿æ¥        request: è¯·æ±‚å‚æ•°    Returns:        Any    &quot;&quot;&quot;    # è·å–æŸ¥è¯¢ç»“æœï¼ˆåˆ—è¡¨ï¼‰    data = case_list_crud(request, db_session)    return BaseResponse[PeopleDataModel].success(data=data)\n\nå¦‚æœè¿”å›çš„æ•°æ®dataæ˜¯åˆ—è¡¨from typing import List@router.post(&quot;/case_list/1.0.0&quot;, response_model=BaseResponse[List[PeopleDataModel]], name=&quot;ç”¨ä¾‹åˆ—è¡¨&quot;)def case_list(    db_session: DbSessionDep    request: ApiCaseManagerCaseListRequest) -&gt; Any:    &quot;&quot;&quot;ç”¨ä¾‹åˆ—è¡¨    Args:        db_session: æ•°æ®åº“è¿æ¥        request: è¯·æ±‚å‚æ•°    Returns:        Any    &quot;&quot;&quot;    # è·å–æŸ¥è¯¢ç»“æœï¼ˆåˆ—è¡¨ï¼‰    data = case_list_crud(request, db_session) # è¿”å›çš„åˆ—è¡¨ä¸­æ•°æ®çš„ç±»å‹æ˜¯ PeopleDataModel    return BaseResponse[List[PeopleDataModel]].success(data=data)\n\nè¿”å›æ•°æ®æ ¼å¼ç¤ºä¾‹&#123;  &quot;code&quot;: 0,  &quot;rec_ts&quot;: 1611399999.999999,  &quot;rsp_ts&quot;: 1611399999.999999,  &quot;msg&quot;: &quot;success&quot;,  &quot;data&quot;:[    &#123;    &quot;numbers&quot;: 0,    &quot;people&quot;: &quot; å°æ˜&quot;    &#125;,    &#123;    &quot;numbers&quot;: 2,    &quot;people&quot;: &quot; å°è˜‘è‡&quot;    &#125;  ]&#125;\n\nè¿”å›ä½“ç»“æ„çµæ„Ÿæ¥æºï¼šhttps://docs.pydantic.dev/2.8/concepts/models/#generic-models ä¸­çš„ Generic models ç« èŠ‚ã€‚\nå¼‚å¸¸æ•è·å®šä¹‰å¼‚å¸¸ç±»class ResponseErrorV2(Exception):    def __init__(self, status_code: int, code: int, msg: str):        self.status_code = status_code        self.code = code        self.msg = msg\n\nfastapiæ•è·å¼‚å¸¸main.py å…¥å£å‡½æ•°ï¼š\n@app.exception_handler(ResponseErrorV2)async def custom_error_handler(request: Request, exc: ResponseErrorV2):    return JSONResponse(        status_code=exc.status_code,        content=&#123;&quot;code&quot;: exc.code, &quot;msg&quot;: exc.msg&#125;,    )\n\nä¸»åŠ¨æŠ›å¼‚å¸¸raise ResponseErrorV2(status_code=400, code=400001, msg=&quot;è¯·æ±‚å¤´å¿…é¡»æºå¸¦Token&quot;)\n\næ¥å£è¿”å›æ•°æ®ç»“æ„status: 400\n&#123;  &quot;code&quot;: 400001,  &quot;msg&quot;: &quot;è¯·æ±‚å¤´å¿…é¡»æºå¸¦Token&quot;&#125;\n\n\nç”Ÿæˆæ–‡æ¡£å¯åŠ¨fastapiæœåŠ¡ï¼Œç¼–å†™shellè„šæœ¬ï¼šgenerate_swagger.sh\n#! /bin/bashcurl -X GET http://127.0.0.1:9000/openapi.json &gt; docs/api/swagger.json\n\nåˆ†åˆ«æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š\nchmod +x generate_swagger.sh./generate_swagger.sh\n\næ€»ç»“pydantic ä¸ä»…å¯ä»¥åœ¨ç¼–å†™ä»£ç çš„è¿‡ç¨‹ä¸­è§„èŒƒä¹¦å†™æ ¼å¼ï¼Œè¿˜èƒ½è‡ªåŠ¨åŒ–ç”Ÿæˆæ–‡æ¡£ï¼Œè¿˜å¯ä»¥å¸®æˆ‘ä»¬æ ¡éªŒå‡ºå…¥å‚çš„æ ¼å¼ï¼Œè®©ä»£ç çš„å¯è¯»æ€§è¿›ä¸€æ­¥åŠ å¼ºã€‚\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.152-fastapiä¸­å¦‚ä½•å†™webhookæ¥å£","url":"/2025/08/11/No-152-fastapi%E4%B8%AD%E5%A6%82%E4%BD%95%E5%86%99webhook%E6%8E%A5%E5%8F%A3/","content":"å¯¼è¯»åœ¨æ„å»º CICD çš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šç”¨åˆ°ä¸€äº›å·¥å…·ï¼Œæ¯”å¦‚ï¼šJenkinsã€GitLabã€Coding ç­‰ã€‚\nè¿™äº›æ„å»ºå·¥å…·éƒ½æœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼šå®ƒä»¬èƒ½æ”¯æŒ webHook çš„è§¦å‘ã€‚\næ¯”å¦‚ gitlib ä¸­è®¾ç½®å½“å‰ push ä»£ç çš„æ—¶å€™è§¦å‘ webhookã€‚\nå½“æˆ‘ä»¬é…ç½®äº† webhook ä»¥åï¼Œä¼šåœ¨è§¦å‘äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œå»è¯·æ±‚ä¸€ä¸ªè‡ªå®šä¹‰çš„ urlã€‚\nè¿™æ ·å°±ä¸°å¯Œäº†æˆ‘ä»¬åœ¨æ„å»º CICD çš„æµç¨‹ä¸­ï¼Œå»å¤„ç†æ›´å¤šçš„ä¸šåŠ¡é€»è¾‘ã€‚\nwebhook å¦‚ä½•è‡ªå®šä¹‰æ¥å£@router.post(&quot;/webhook/1.0.0&quot;, name=&quot;webhook&quot;)async def add_new(    request: Request,) -&gt; Any:    # è§£æ Webhook è¯·æ±‚ä½“çš„ JSON æ•°æ®    body = await request.body()    # è§£æ JSON æ•°æ®    try:        data = json.loads(body.decode(&quot;utf-8&quot;))    except json.JSONDecodeError:        return Response(&quot;ok&quot;)    logger.info(f&quot;webhookçš„body=&#123;data&#125;&quot;)    # è¿™é‡Œæ·»åŠ ä¸šåŠ¡é€»è¾‘    # ...    return Response(&quot;ok&quot;)\n\nè¯´æ˜\nè¯·æ±‚æ–¹æ³•å®šä¹‰ä¸º postï¼Œä¸€èˆ¬è¦ä½¿ç”¨postæ–¹æ³•ã€‚\nè®¾ç½®è¯·æ±‚ç±»å‹ä¸º application&#x2F;json\nè¯»å–è¯·æ±‚æ•°æ®ï¼Œå¹¶è§£æã€‚body = await request.body()\nè¯»å– json æ•°æ®,data = json.loads(body.decode(&quot;utf-8&quot;))ï¼Œè¿™é‡Œè¦æ³¨æ„å¼‚å¸¸çš„æ•è·ï¼Œé˜²æ­¢æŠ¥é”™ã€‚\nåœ¨å¤„ç†é€»è¾‘ä¸­ï¼Œä¸€èˆ¬éœ€è¦è¿›è¡Œæ•°æ®æ ¡éªŒï¼Œé¿å…æ¥å£æŠ¥é”™ã€‚\nåœ¨éœ€è¦ä½¿ç”¨æ—¥å¿—ä¿¡æ¯æ—¶ï¼Œè¦æ·»åŠ  loggerã€‚\nè§£æ body ä¸­çš„å‚æ•°ã€‚\næ·»åŠ ä¸šåŠ¡å¤„ç†é€»è¾‘ã€‚\nè¿”å› ok, è¿”å› ok å‘Šè¯‰ webhook é€šçŸ¥å‘é€ç«¯ï¼Œæ¥å£æ­£å¸¸å¤„ç†å®Œæˆã€‚è¿™é‡Œè¦è®°ä½ä¸€å®šè¦è¿”å› okï¼Œå¦åˆ™ä¼šä¸åœçš„è§¦å‘äº‹ä»¶ã€‚return Response(&quot;ok&quot;)\n\nå¦‚ä½•æµ‹è¯•ï¼Ÿä½¿ç”¨ curl çš„ post æ–¹å¼ï¼Œå¸¦ä¸Š body æ•°æ®ï¼Œç¤ºä¾‹ï¼š\ncurl --location --request POST &#x27;http://127.0.0.1:9000/webhook/1.0.0&#x27; \\--header &#x27;Content-Type: application/json&#x27; \\--data-raw &#x27;&#123;&quot;object_kind&quot;: &quot;deployment&quot;, &quot;id&quot;: 123&#125;&#x27;\n\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.151-fastapiä¸­æ‰¹é‡æ›´æ–°æ•°æ®æ€ä¹ˆä¿è¯æ•°æ®çš„ä¸€è‡´æ€§","url":"/2025/08/10/No-151-fastapi%E4%B8%AD%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E6%80%8E%E4%B9%88%E4%BF%9D%E8%AF%81%E6%95%B0%E6%8D%AE%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7/","content":"å¯¼è¯»åœ¨ fastapi ä¸­ï¼ŒAPI æœ€å¸¸è§çš„æƒ…å†µæ˜¯æ‰¹é‡æ›´æ–°æ•°æ®ï¼Œä¸€ä¸ªé€»è¾‘å±‚çš„å‡½æ•°å¯èƒ½åŒ…å«å¤šæ¬¡æ•°æ®åº“äº¤äº’ï¼Œæœ‰æ–°å¢æ•°æ®ã€æ›´æ–°æ•°æ®é€»è¾‘ï¼Œé‚£ä¹ˆåœ¨ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§æ–¹é¢åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ\nä¸‹é¢æˆ‘å°†è¯¦ç»†è¯´æ˜åœ¨ FastAPI ä¸­å®ç°æ‰¹é‡æ›´æ–°çš„ä¸¤ç§ä¸»è¦æ–¹å¼ï¼Œå¹¶æä¾›å®Œæ•´çš„ä»£ç ç¤ºä¾‹ã€‚\n1. ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡å®ç°æ‰¹é‡æ›´æ–°è¿™ç§æ–¹å¼é€šè¿‡æ•°æ®åº“äº‹åŠ¡ä¿è¯æ‰€æœ‰æ›´æ–°æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚\nå®Œæ•´ç¤ºä¾‹ä»£ç from fastapi import FastAPI, HTTPException, Dependsfrom pydantic import BaseModelfrom typing import Listfrom sqlalchemy import create_engine, Column, Integer, Stringfrom sqlalchemy.ext.declarative import declarative_basefrom sqlalchemy.orm import sessionmaker, Session# æ•°æ®åº“é…ç½®SQLALCHEMY_DATABASE_URL = &quot;sqlite:///./test.db&quot;engine = create_engine(SQLALCHEMY_DATABASE_URL)SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)Base = declarative_base()# æ•°æ®åº“æ¨¡å‹class User(Base):    __tablename__ = &quot;users&quot;    id = Column(Integer, primary_key=True, index=True)    name = Column(String(50))    email = Column(String(50))    status = Column(String(20))# åˆ›å»ºè¡¨Base.metadata.create_all(bind=engine)# Pydantic æ¨¡å‹class UserUpdate(BaseModel):    id: int    name: str = None    email: str = None    status: str = Noneapp = FastAPI()# ä¾èµ–é¡¹ - è·å–æ•°æ®åº“ä¼šè¯def get_db():    db = SessionLocal()    try:        yield db    finally:        db.close()@app.put(&quot;/users/bulk-update-transaction&quot;)async def bulk_update_users_transaction(    users: List[UserUpdate],     db: Session = Depends(get_db)):    try:        # å¼€å§‹äº‹åŠ¡        db.begin()                for user_data in users:            # æŸ¥è¯¢ç”¨æˆ·            user = db.query(User).filter(User.id == user_data.id).first()            if not user:                raise HTTPException(status_code=404, detail=f&quot;User with id &#123;user_data.id&#125; not found&quot;)                        # æ›´æ–°å­—æ®µ            if user_data.name is not None:                user.name = user_data.name            if user_data.email is not None:                user.email = user_data.email            if user_data.status is not None:                user.status = user_data.status                        # ä¹Ÿå¯ä»¥ä½¿ç”¨ merge æ–¹æ³•            # db.merge(user)                # æäº¤äº‹åŠ¡        db.commit()    except HTTPException:        # å·²çŸ¥å¼‚å¸¸ç›´æ¥æŠ›å‡º        db.rollback()        raise    except Exception as e:        # å…¶ä»–å¼‚å¸¸å›æ»šå¹¶è¿”å›é”™è¯¯        db.rollback()        raise HTTPException(status_code=500, detail=str(e))        return &#123;&quot;message&quot;: &quot;Batch update completed successfully&quot;, &quot;updated_count&quot;: len(users)&#125;\n\nå…³é”®ç‚¹è¯´æ˜\näº‹åŠ¡ç®¡ç†ï¼š\n\ndb.begin() æ˜¾å¼å¼€å§‹äº‹åŠ¡\ndb.commit() æäº¤äº‹åŠ¡\ndb.rollback() åœ¨å¼‚å¸¸æ—¶å›æ»š\n\n\né”™è¯¯å¤„ç†ï¼š\n\nå¤„ç†äº†ç”¨æˆ·ä¸å­˜åœ¨çš„åœºæ™¯\næ•è·æ‰€æœ‰å¼‚å¸¸ç¡®ä¿äº‹åŠ¡å›æ»š\nè¿”å›é€‚å½“çš„HTTPçŠ¶æ€ç \n\n\nåŸå­æ€§ä¿è¯ï¼š\n\næ‰€æœ‰æ›´æ–°è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥\nä¸­é—´å‡ºé”™ä¸ä¼šå¯¼è‡´éƒ¨åˆ†æ›´æ–°\n\n\n\n2. ä½¿ç”¨æ‰¹é‡æ“ä½œè¯­å¥å®ç°æ‰¹é‡æ›´æ–°è¿™ç§æ–¹å¼é€šè¿‡å•ä¸ªSQLè¯­å¥æ‰§è¡Œæ‰¹é‡æ›´æ–°ï¼Œæ•ˆç‡æ›´é«˜ã€‚\nå®Œæ•´ç¤ºä¾‹ä»£ç 2from sqlalchemy import update, bindparam@app.put(&quot;/users/bulk-update-bulk-statement&quot;)async def bulk_update_users_bulk_statement(    users: List[UserUpdate],     db: Session = Depends(get_db)):    try:        # æ„å»ºæ‰¹é‡æ›´æ–°è¯­å¥        stmt = (            update(User)            .where(User.id == bindparam(&#x27;user_id&#x27;))            .values(&#123;                User.name: bindparam(&#x27;user_name&#x27;),                User.email: bindparam(&#x27;user_email&#x27;),                User.status: bindparam(&#x27;user_status&#x27;)            &#125;)        )                # å‡†å¤‡å‚æ•°åˆ—è¡¨        params = []        for user in users:            param = &#123;                &#x27;user_id&#x27;: user.id,                &#x27;user_name&#x27;: user.name,                &#x27;user_email&#x27;: user.email,                &#x27;user_status&#x27;: user.status            &#125;            params.append(param)                # æ‰§è¡Œæ‰¹é‡æ›´æ–°        result = db.execute(stmt, params)        db.commit()                # è¿”å›æ›´æ–°çš„è¡Œæ•°        updated_count = result.rowcount            except Exception as e:        db.rollback()        raise HTTPException(status_code=500, detail=str(e))        return &#123;        &quot;message&quot;: &quot;Batch update completed with bulk statement&quot;,        &quot;updated_count&quot;: updated_count    &#125;\n\nå…³é”®ç‚¹è¯´æ˜2\næ‰¹é‡SQLæ„å»ºï¼š\n\nä½¿ç”¨ update() å’Œ bindparam() æ„å»ºå‚æ•°åŒ–æŸ¥è¯¢\nå•ä¸ªSQLè¯­å¥å¤„ç†æ‰€æœ‰æ›´æ–°\n\n\nå‚æ•°å‡†å¤‡ï¼š\n\nå°†è¾“å…¥æ•°æ®è½¬æ¢ä¸ºå‚æ•°åˆ—è¡¨\næ¯ä¸ªå‚æ•°å¯¹åº”ä¸€ä¸ªå­—å…¸\n\n\næ‰§è¡Œæ•ˆç‡ï¼š\n\nç›¸æ¯”å¾ªç¯æ›´æ–°ï¼Œå‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°\næ•°æ®åº“å¯ä»¥ä¼˜åŒ–æ‰§è¡Œè®¡åˆ’\n\n\nè¿”å›å€¼ï¼š\n\né€šè¿‡ result.rowcount è·å–å®é™…æ›´æ–°çš„è¡Œæ•°\n\n\n\nä¸¤ç§æ–¹å¼çš„æ¯”è¾ƒ\n\n\nç‰¹æ€§\näº‹åŠ¡æ–¹å¼\næ‰¹é‡è¯­å¥æ–¹å¼\n\n\n\nå®ç°å¤æ‚åº¦\nç®€å•ç›´æ¥\néœ€è¦æ„å»ºSQLè¯­å¥\n\n\næ€§èƒ½\nä¸­ç­‰ï¼ˆå¤šæ¬¡æ•°æ®åº“è°ƒç”¨ï¼‰\né«˜ï¼ˆå•æ¬¡æ•°æ®åº“è°ƒç”¨ï¼‰\n\n\nçµæ´»æ€§\né«˜ï¼ˆå¯å¤„ç†å¤æ‚é€»è¾‘ï¼‰\nä¸­ï¼ˆé€‚åˆç®€å•å­—æ®µæ›´æ–°ï¼‰\n\n\né”™è¯¯å¤„ç†\nå¯ä»¥é€æ¡æ£€æŸ¥\næ‰¹é‡å¤„ç†ï¼Œéš¾ä»¥å•ç‹¬å¤„ç†æŸæ¡å¤±è´¥\n\n\né€‚ç”¨åœºæ™¯\néœ€è¦å¤æ‚é€»è¾‘æˆ–éªŒè¯çš„æ›´æ–°\nå¤§æ‰¹é‡ç®€å•å­—æ®µæ›´æ–°\n\n\næµ‹è¯•ç¤ºä¾‹ä½ å¯ä»¥ä½¿ç”¨è¿™æ ·çš„è¯·æ±‚ä½“æµ‹è¯•ä¸Šè¿°APIï¼š\n[    &#123;        &quot;id&quot;: 1,        &quot;name&quot;: &quot;New Name 1&quot;,        &quot;email&quot;: &quot;new1@example.com&quot;,        &quot;status&quot;: &quot;active&quot;    &#125;,    &#123;        &quot;id&quot;: 2,        &quot;name&quot;: &quot;New Name 2&quot;,        &quot;email&quot;: &quot;new2@example.com&quot;,        &quot;status&quot;: &quot;inactive&quot;    &#125;]\n\nå®é™…ä¸šåŠ¡ä¸­ï¼Œæ ¹æ®ä½ çš„å…·ä½“éœ€æ±‚é€‰æ‹©åˆé€‚çš„å®ç°æ–¹å¼ã€‚\n\nå¯¹äºéœ€è¦å¤æ‚ä¸šåŠ¡é€»è¾‘çš„æ›´æ–°ï¼Œäº‹åŠ¡æ–¹å¼æ›´åˆé€‚ï¼›\nå¯¹äºçº¯ç²¹çš„å¤§æ‰¹é‡æ•°æ®æ›´æ–°ï¼Œæ‰¹é‡è¯­å¥æ–¹å¼æ€§èƒ½æ›´å¥½ã€‚\n\næ€»ä¹‹ï¼šåœ¨ä¸€ä¸ªé€»è¾‘å‡½æ•°ä¸­å¤„ç†äº‹åŠ¡ï¼Œé¿å…ä¸­é—´çŠ¶æ€ï¼Œç¡®ä¿åŸå­æ€§å’Œä¸€è‡´æ€§ï¼Œå°½é‡ä¸è¦å†™ä¸€æ®µé€»è¾‘æäº¤ä¸€æ¬¡ï¼Œè€Œæ˜¯åœ¨é€»è¾‘å‡½æ•°ç»“æŸæ—¶å€™æäº¤æˆ–å›æ»šä¸€æ¬¡ã€‚å¦‚æœé‡åˆ°é«˜å¹¶å‘åœºæ™¯ï¼Œè¿˜éœ€è¦è€ƒè™‘é”ç­–ç•¥ã€‚\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.154-å¦‚ä½•åœ¨fastapiä¸­ä½¿ç”¨BackgroundTasks","url":"/2025/08/12/No-154-%E5%A6%82%E4%BD%95%E5%9C%A8fastapi%E4%B8%AD%E4%BD%BF%E7%94%A8BackgroundTasks/","content":"å¯¼è¯»FastAPI çš„ BackgroundTasks åŠŸèƒ½å…è®¸ä½ å°†ä»»åŠ¡æ·»åŠ åˆ°åå°æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥åœ¨å“åº”è¿”å›ç»™å®¢æˆ·ç«¯åç»§ç»­å¤„ç†è€—æ—¶æ“ä½œã€‚\nå¸¸ç”¨çš„åœºæ™¯æœ‰å‘é€é‚®ä»¶ï¼Œå‘é€çŸ­ä¿¡ç­‰ã€‚\nè¿™ä¸ªåŠŸèƒ½å°½é‡ä¸è¦ä½¿ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œå¦‚æœåŠŸèƒ½æ˜¯è¾¹ç¼˜ä¸šåŠ¡ï¼Œå€’æ˜¯å¯ä»¥ä½¿ç”¨ï¼Œç®€å•æ–¹ä¾¿ã€‚å®ƒçš„ç¼ºç‚¹å°±æ˜¯å‡ºäº†é—®é¢˜ï¼Œå¾ˆéš¾å®šä½é—®é¢˜æ‰€åœ¨ã€‚éœ€è¦æ·»åŠ è¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ã€‚\nä»¥ä¸‹æ˜¯ä½¿ç”¨ BackgroundTasks çš„è¯¦ç»†æŒ‡å—ï¼š\nåŸºæœ¬ç”¨æ³•\né¦–å…ˆå¯¼å…¥ BackgroundTasksï¼š\n\nfrom fastapi import BackgroundTasks, FastAPI\n\n\nåˆ›å»º FastAPI åº”ç”¨å¹¶å®šä¹‰åå°ä»»åŠ¡å‡½æ•°ï¼š\n\napp = FastAPI()def write_log(message: str):    with open(&quot;log.txt&quot;, mode=&quot;a&quot;) as log:        log.write(message)def send_email(email: str, message: str):    # æ¨¡æ‹Ÿå‘é€ç”µå­é‚®ä»¶    print(f&quot;å‘é€é‚®ä»¶åˆ° &#123;email&#125;: &#123;message&#125;&quot;)\n\n\nåœ¨è·¯å¾„æ“ä½œä¸­ä½¿ç”¨ BackgroundTasksï¼š\n\n@app.post(&quot;/send-notification/&#123;email&#125;&quot;)async def send_notification(email: str, background_tasks: BackgroundTasks):    background_tasks.add_task(send_email, email, message=&quot;è¿™æ˜¯ä¸€æ¡é€šçŸ¥&quot;)    background_tasks.add_task(write_log, f&quot;å‘é€é€šçŸ¥åˆ° &#123;email&#125;&quot;)    return &#123;&quot;message&quot;: &quot;é€šçŸ¥å·²å‘é€&quot;&#125;\n\né«˜çº§ç”¨æ³•1. ä¾èµ–æ³¨å…¥ä½ å¯ä»¥å°† BackgroundTasks ä½œä¸ºä¾èµ–é¡¹æ³¨å…¥ï¼š\nfrom fastapi import Dependsdef get_background_tasks(background_tasks: BackgroundTasks = BackgroundTasks()):    return background_tasks@app.post(&quot;/another-route&quot;)async def another_route(background_tasks: BackgroundTasks = Depends(get_background_tasks)):    background_tasks.add_task(some_task)    return &#123;&quot;message&quot;: &quot;ä»»åŠ¡å·²æ·»åŠ &quot;&#125;\n\n2. ä¸è·¯å¾„æ“ä½œå‡½æ•°ä¸€èµ·ä½¿ç”¨åå°ä»»åŠ¡å¯ä»¥ä¸å¸¸è§„è·¯å¾„æ“ä½œå‡½æ•°ä¸€èµ·ä½¿ç”¨ï¼š\n@app.post(&quot;/process-data&quot;)async def process_data(    data: dict,    background_tasks: BackgroundTasks):    # ç«‹å³å¤„ç†ä¸€äº›æ•°æ®    processed_data = &#123;k: v.upper() for k, v in data.items()&#125;        # æ·»åŠ åå°ä»»åŠ¡    background_tasks.add_task(store_data_in_db, processed_data)        return &#123;&quot;processed_data&quot;: processed_data&#125;\n\n3. ç±»æ–¹æ³•ä½œä¸ºåå°ä»»åŠ¡ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ç±»æ–¹æ³•ä½œä¸ºåå°ä»»åŠ¡ï¼š\nclass NotificationService:    @classmethod    def send_email(cls, email: str, message: str):        # å‘é€é‚®ä»¶é€»è¾‘        pass@app.post(&quot;/send-email&quot;)async def send_email_route(    email: str,     background_tasks: BackgroundTasks):    background_tasks.add_task(        NotificationService.send_email,        email,        message=&quot;Hello from FastAPI&quot;    )    return &#123;&quot;status&quot;: &quot;Email will be sent&quot;&#125;\n\næ³¨æ„äº‹é¡¹\nä»»åŠ¡é¡ºåºï¼šæ·»åŠ ä»»åŠ¡çš„é¡ºåºå°±æ˜¯å®ƒä»¬æ‰§è¡Œçš„é¡ºåºã€‚\n\nå¼‚å¸¸å¤„ç†ï¼šåå°ä»»åŠ¡ä¸­çš„å¼‚å¸¸ä¸ä¼šä¼ æ’­åˆ°ä¸»è¯·æ±‚ï¼Œéœ€è¦è‡ªè¡Œå¤„ç†ã€‚\n\næµ‹è¯•ï¼šåœ¨æµ‹è¯•æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ BackgroundTasks çš„ tasks å±æ€§æ¥æ£€æŸ¥æ·»åŠ çš„ä»»åŠ¡ï¼š\n\n\ndef test_background_task():    background_tasks = BackgroundTasks()    test_app.add_task(some_task)    assert len(background_tasks.tasks) == 1\n\n\né•¿æ—¶é—´è¿è¡Œä»»åŠ¡ï¼šå¯¹äºéå¸¸è€—æ—¶çš„ä»»åŠ¡ï¼Œè€ƒè™‘ä½¿ç”¨ Celery æˆ–å…¶ä»–ä»»åŠ¡é˜Ÿåˆ—ã€‚\n\nä¾èµ–é¡¹ï¼šåå°ä»»åŠ¡å‡½æ•°å¯ä»¥æ¥å— FastAPI çš„ä¾èµ–é¡¹ã€‚\n\n\nå®Œæ•´ç¤ºä¾‹from fastapi import FastAPI, BackgroundTasksimport timeapp = FastAPI()def process_data_in_background(data: dict):    # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ    time.sleep(5)    with open(&quot;processed_data.txt&quot;, &quot;a&quot;) as f:        f.write(f&quot;&#123;data&#125;\\n&quot;)@app.post(&quot;/process/&quot;)async def process_data(data: dict, background_tasks: BackgroundTasks):    background_tasks.add_task(process_data_in_background, data)    return &#123;&quot;message&quot;: &quot;æ•°æ®æ­£åœ¨åå°å¤„ç†&quot;, &quot;data&quot;: data&#125;\n\né€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥è½»æ¾åœ°å°†è€—æ—¶æ“ä½œæ”¾åˆ°åå°æ‰§è¡Œï¼ŒåŒæ—¶ç«‹å³è¿”å›å“åº”ç»™å®¢æˆ·ç«¯ã€‚\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.155-fastapié¡¹ç›®ä¸­Dockerfileæ€ä¹ˆå†™","url":"/2025/08/14/No-155-fastapi%E9%A1%B9%E7%9B%AE%E4%B8%ADDockerfile%E6%80%8E%E4%B9%88%E5%86%99/","content":"å¯¼è¯»fastapi é¡¹ç›®ä»£ç å†™å®Œäº†ï¼Œæ€ä¹ˆæ‰“åŒ…éƒ¨ç½²ï¼Ÿ\néƒ¨ç½²åˆ° k8s é›†ç¾¤ä¸­ï¼ŒDockerfile æ€ä¹ˆå†™å‘¢ï¼Ÿ\nä»¥ä¸‹æ˜¯é’ˆå¯¹ FastAPI é¡¹ç›®çš„ ç”Ÿäº§çº§ Dockerfile ç¤ºä¾‹ï¼ŒåŒ…å«æ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨å®è·µå’Œ Kubernetes é€‚é…å»ºè®®ï¼Œæ”¯æŒå¼‚æ­¥è¯·æ±‚å’Œé«˜å¹¶å‘åœºæ™¯ï¼š\nä¼˜åŒ–ç‰ˆ Dockerfileï¼ˆæ”¯æŒ ASGI + å¤šé˜¶æ®µæ„å»ºï¼‰# é˜¶æ®µ1ï¼šæ„å»ºä¾èµ–FROM python:3.11-slim as builderWORKDIR /appENV PYTHONUNBUFFERED=1 \\    PIP_NO_CACHE_DIR=1 \\    PIP_DISABLE_PIP_VERSION_CHECK=1# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆæ ¹æ®é¡¹ç›®éœ€æ±‚è°ƒæ•´ï¼‰RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \\    gcc python3-dev &amp;&amp; \\    rm -rf /var/lib/apt/lists/*# å®‰è£…Pythonä¾èµ–ï¼ˆåˆ†å±‚ä¼˜åŒ–ï¼Œåˆ©ç”¨Dockerç¼“å­˜ï¼‰COPY requirements.txt .RUN pip install --user --no-warn-script-location -r requirements.txt# ---# é˜¶æ®µ2ï¼šç”Ÿäº§é•œåƒFROM python:3.11-slimWORKDIR /app# ä»builderé˜¶æ®µå¤åˆ¶å·²å®‰è£…çš„PythonåŒ…COPY --from=builder /root/.local /root/.local# å¤åˆ¶é¡¹ç›®ä»£ç ï¼ˆé€šè¿‡.dockerignoreè¿‡æ»¤æ— å…³æ–‡ä»¶ï¼‰COPY . .# å®‰å…¨é…ç½®ï¼šä½¿ç”¨érootç”¨æˆ·RUN useradd -m appuser &amp;&amp; chown -R appuser /appUSER appuser# ç¯å¢ƒå˜é‡ENV PATH=/home/appuser/.local/bin:$PATH \\    PYTHONUNBUFFERED=1 \\    PYTHONPATH=/app \\    UVICORN_HOST=0.0.0.0 \\    UVICORN_PORT=8000# æš´éœ²ç«¯å£EXPOSE 8000# å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ˆéœ€åœ¨FastAPIä¸­å®ç°/healthï¼‰HEALTHCHECK --interval=30s --timeout=3s \\  CMD curl -f http://localhost:8000/health || exit 1# å¯åŠ¨å‘½ä»¤ï¼ˆæ¨èä½¿ç”¨Uvicorn + Gunicornç»„åˆï¼‰CMD [&quot;gunicorn&quot;, &quot;-k&quot;, &quot;uvicorn.workers.UvicornWorker&quot;, &quot;--bind&quot;, &quot;0.0.0.0:8000&quot;, &quot;--workers&quot;, &quot;4&quot;, &quot;app.main:app&quot;]\n\n\nå…³é”®ä¼˜åŒ–ç‚¹è§£æ\nASGI æœåŠ¡å™¨é€‰æ‹©  \n\nä½¿ç”¨ UvicornWorker + Gunicorn ç»„åˆï¼š\nUvicorn å¤„ç†å¼‚æ­¥è¯·æ±‚\nGunicorn ç®¡ç†è¿›ç¨‹ï¼ˆå»ºè®® worker æ•° &#x3D; min(2*CPUæ ¸å¿ƒ+1, 8)ï¼‰\n\n\n\n\nå®‰å…¨å¢å¼º  \n\nç¦ç”¨ root ç”¨æˆ·è¿è¡Œå®¹å™¨\né€šè¿‡ .dockerignore æ’é™¤ __pycache__ã€.env ç­‰æ•æ„Ÿæ–‡ä»¶\nä½¿ç”¨ --no-warn-script-location é¿å…æƒé™è­¦å‘Š\n\n\nKubernetes é€‚é…  \n\nå¥åº·æ£€æŸ¥ï¼šåœ¨ Deployment ä¸­é…ç½®ï¼š\nlivenessProbe:  httpGet:    path: /health    port: 8000\n\nèµ„æºé™åˆ¶ï¼šå»ºè®®åœ¨ K8s ä¸­è®¾ç½® CPU&#x2F;Memory é™åˆ¶\n\nç¯å¢ƒå˜é‡ï¼šæ•æ„Ÿé…ç½®é€šè¿‡ K8s Secrets æ³¨å…¥\n\n\n\næ€§èƒ½ä¼˜åŒ–  \n\nå¤šé˜¶æ®µæ„å»ºå‡å°‘é•œåƒä½“ç§¯ï¼ˆæœ€ç»ˆé•œåƒçº¦ 150MBï¼‰\nä¾èµ–åˆ†å±‚å®‰è£…ï¼ˆä¿®æ”¹ä»£ç æ—¶ä¸ä¼šé‡æ–°å®‰è£…ä¾èµ–ï¼‰\n\n\n\n\nä¸åŒåœºæ™¯çš„å¯åŠ¨å‘½ä»¤è°ƒæ•´\n\n\nåœºæ™¯\nCMD æŒ‡ä»¤ç¤ºä¾‹\n\n\n\nçº¯å¼€å‘ç¯å¢ƒ\nCMD [&quot;uvicorn&quot;, &quot;app.main:app&quot;, &quot;--reload&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;]\n\n\né«˜å¹¶å‘ç”Ÿäº§ç¯å¢ƒ\nCMD [&quot;gunicorn&quot;, &quot;-k&quot;, &quot;uvicorn.workers.UvicornWorker&quot;, &quot;--bind&quot;, &quot;...&quot;]\n\n\nå•èŠ‚ç‚¹æµ‹è¯•\nCMD [&quot;uvicorn&quot;, &quot;app.main:app&quot;, &quot;--workers&quot;, &quot;4&quot;]\n\n\n\né…å¥—çš„ requirements.txt å»ºè®®fastapi==0.109.0uvicorn==0.27.0gunicorn==21.2.0# å…¶ä»–ä¾èµ–...\n\n\nå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ\né™æ€æ–‡ä»¶å¤„ç†æ·»åŠ  Nginx å®¹å™¨æˆ–é€šè¿‡ Kubernetes Ingress é…ç½®ï¼š\nRUN pip install aiofiles  # ç”¨äºå¼‚æ­¥é™æ€æ–‡ä»¶å¤„ç†\n\nAlpine é•œåƒé—®é¢˜å¦‚éœ€æ›´å°é•œåƒï¼Œå¯æ›¿æ¢åŸºç¡€é•œåƒä¸º python:3.11-alpineï¼Œä½†éœ€æ³¨æ„ï¼š\nRUN apk add --no-cache gcc musl-dev  # Alpineç‰ˆgcc\n\nè¶…æ—¶æ§åˆ¶åœ¨ Gunicorn ä¸­å¢åŠ å‚æ•°ï¼š\nCMD [&quot;gunicorn&quot;, &quot;--timeout&quot;, &quot;120&quot;, &quot;...&quot;]\n\nç®€ç‰ˆ Dockerfile (ç›´æ¥ä½¿ç”¨fastapiå‘½ä»¤å¯åŠ¨)ï¼ˆå¿«é€Ÿå¯åŠ¨æ¨èä½¿ç”¨ï¼‰FROM python:3.12LABEL authors=&quot;&lt;your name&gt;&quot;WORKDIR /code# RUN apt-get update -y &amp;&amp; apt-get install -y python3-pip &amp;&amp; pip3 install pip --upgradeCOPY requirements.txt requirements.txtRUN pip3 install --no-cache-dir -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/COPY . .# æ‰¹é‡è®¾ç½®æ‰§è¡Œæƒé™RUN find . -name &quot;*.sh&quot; -exec chmod +x &#123;&#125; \\;CMD [&quot;./run_main.sh&quot;]\n\nrun_main.sh:\n#! /bin/bashexport PYTHONPATH=/code:$PYTHONPATHfastapi run --port 9000\n\næœ¬åœ°å¼€å‘ç¯å¢ƒï¼Œrun_dev.shçš„å¯åŠ¨è„šæœ¬ï¼š\n#! /bin/bashexport PYTHONPATH=/code:$PYTHONPATHfastapi dev --port 9000 --reload\n\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.156-fastapiä¸­å¥åº·æ£€æŸ¥æ¥å£æ€ä¹ˆå†™","url":"/2025/08/18/No-156-fastapi%E4%B8%AD%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E6%8E%A5%E5%8F%A3%E6%80%8E%E4%B9%88%E5%86%99/","content":"å¯¼è¯»fastapi é¡¹ç›®ä»£ç å†™å®Œäº†ï¼Œéƒ¨ç½²çš„æ—¶å€™ï¼Œè¿ç»´åŒå­¦è¦æ±‚è¦æœ‰ health å¥åº·æ£€æŸ¥æ¥å£ï¼Œæ€ä¹ˆåŠï¼Ÿ\nåŸºç¡€å®ç°ï¼ˆç®€å•ç‰ˆï¼‰from fastapi import FastAPI, APIRouterapp = FastAPI()# å¥åº·æ£€æŸ¥ç«¯ç‚¹@app.get(&quot;/health&quot;)async def health_check():    return &#123;&quot;status&quot;: &quot;ok&quot;, &quot;message&quot;: &quot;Service is healthy&quot;&#125;\n\né«˜çº§å®ç°ï¼ˆå¸¦æ ¸å¿ƒä¾èµ–æ£€æŸ¥ï¼‰from fastapi import FastAPI, APIRouter, Depends, HTTPExceptionfrom sqlalchemy import textfrom redis import Redisfrom .database import SessionLocal  # å‡è®¾ä½ æœ‰ä¸€ä¸ªæ•°æ®åº“ä¼šè¯app = FastAPI()# ä¾èµ–é¡¹ç¤ºä¾‹def get_db():    db = SessionLocal()    try:        yield db    finally:        db.close()# Redis è¿æ¥æ£€æŸ¥def check_redis():    try:        redis = Redis(host=&quot;localhost&quot;, port=6379, db=0)        return redis.ping()    except Exception:        return False# å®Œæ•´å¥åº·æ£€æŸ¥@app.get(&quot;/health&quot;)async def health_check(db: SessionLocal = Depends(get_db)):    checks = &#123;        &quot;database&quot;: False,        &quot;redis&quot;: False,        &quot;service&quot;: True    &#125;        # æ•°æ®åº“æ£€æŸ¥    try:        db.execute(text(&quot;SELECT 1&quot;))        checks[&quot;database&quot;] = True    except Exception as e:        pass        # Redisæ£€æŸ¥    checks[&quot;redis&quot;] = check_redis()        # ç»¼åˆçŠ¶æ€    overall_status = all(checks.values())        if not overall_status:        raise HTTPException(            status_code=503,            detail=&quot;Service Unavailable&quot;,            headers=&#123;&quot;Retry-After&quot;: &quot;10&quot;&#125;        )        return &#123;        &quot;status&quot;: &quot;ok&quot; if overall_status else &quot;degraded&quot;,        &quot;checks&quot;: checks    &#125;\n\nä½¿ç”¨ APIRouterï¼ˆæ¨èç”¨äºæ¨¡å—åŒ–ï¼‰# health_router.pyfrom fastapi import APIRouter, Dependsfrom .dependencies import get_db  # å¯¼å…¥ä½ çš„ä¾èµ–é¡¹router = APIRouter(tags=[&quot;Monitoring&quot;])@router.get(&quot;/health&quot;, summary=&quot;æœåŠ¡å¥åº·æ£€æŸ¥&quot;, response_description=&quot;è¿”å›æœåŠ¡çŠ¶æ€&quot;)async def health_check(db = Depends(get_db)):    # å®ç°æ£€æŸ¥é€»è¾‘...    return &#123;&quot;status&quot;: &quot;ok&quot;&#125;# main.pyfrom fastapi import FastAPIfrom .routers import health_routerapp = FastAPI()app.include_router(health_router.router)\n\nå…³é”®é…ç½®è¯´æ˜\nç«¯ç‚¹é€‰æ‹©ï¼š\n\n/healthï¼šè¡Œä¸šæ ‡å‡†\n/healthzï¼šKubernetes å¸¸ç”¨\n/pingï¼šç®€å•æ¢æµ‹\n\n\nå“åº”è®¾è®¡ï¼š\n&#123;  &quot;status&quot;: &quot;ok&quot;,  // æˆ– &quot;error&quot;/&quot;warning&quot;  &quot;version&quot;: &quot;1.0.0&quot;,  &quot;dependencies&quot;: &#123;    &quot;database&quot;: true,    &quot;cache&quot;: false  &#125;,  &quot;uptime&quot;: 12345.67&#125;\n\nHTTPçŠ¶æ€ç ï¼š\n\n200 OKï¼šæ‰€æœ‰ç³»ç»Ÿæ­£å¸¸\n503 Service Unavailableï¼šå…³é”®æœåŠ¡ä¸å¯ç”¨\n\n\næ€§èƒ½ä¼˜åŒ–ï¼š\n\næ·»åŠ ç¼“å­˜ï¼ˆé¿å…é¢‘ç¹æ£€æŸ¥æ•°æ®åº“ï¼‰\nè®¾ç½®è¶…æ—¶ï¼ˆé˜²æ­¢å¥åº·æ£€æŸ¥é˜»å¡ï¼‰\n\nfrom fastapi import BackgroundTasks@app.get(&quot;/health&quot;)async def health_check(background_tasks: BackgroundTasks):    # å°†è€—æ—¶æ£€æŸ¥æ”¾å…¥åå°    background_tasks.add_task(check_database)    return &#123;&quot;status&quot;: &quot;checking_in_background&quot;&#125;\n\nç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ\næ·»åŠ å®‰å…¨ä¿æŠ¤ï¼š\nfrom fastapi.security import APIKeyHeaderAPI_KEY_NAME = &quot;X-HEALTH-KEY&quot;api_key_scheme = APIKeyHeader(name=API_KEY_NAME)@app.get(&quot;/health&quot;)async def secured_health(key: str = Depends(api_key_scheme)):    if key != &quot;SECRET_KEY&quot;:        raise HTTPException(status_code=403)    return &#123;&quot;status&quot;: &quot;ok&quot;&#125;\n\né›†æˆ Prometheus ç›‘æ§ï¼š\nfrom prometheus_fastapi_instrumentator import InstrumentatorInstrumentator().instrument(app).expose(app)\n\næ·»åŠ ç‰ˆæœ¬ä¿¡æ¯ï¼š\nimport importlib.metadata@app.get(&quot;/health&quot;)async def health_check():    return &#123;        &quot;version&quot;: importlib.metadata.version(&quot;your-package&quot;),        &quot;dependencies&quot;: []    &#125;\n\næµ‹è¯•æ–¹æ³•# test_health.pyfrom fastapi.testclient import TestClientfrom main import appclient = TestClient(app)def test_health_check():    response = client.get(&quot;/health&quot;)    assert response.status_code == 200    assert response.json()[&quot;status&quot;] == &quot;ok&quot;\n\néƒ¨ç½²æ³¨æ„äº‹é¡¹\nåœ¨ Kubernetes ä¸­é…ç½®ï¼š\nlivenessProbe:  httpGet:    path: /health    port: 8000  initialDelaySeconds: 5  periodSeconds: 10readinessProbe:  httpGet:    path: /health    port: 8000  initialDelaySeconds: 30  periodSeconds: 5\n\nåœ¨è´Ÿè½½å‡è¡¡å™¨ï¼ˆå¦‚ Nginxï¼‰ä¸­é…ç½®ï¼š\nlocation = /health &#123;    access_log off;    proxy_pass http://backend;&#125;\n\nè¿™æ ·å®ç°çš„å¥åº·æ£€æŸ¥æ¥å£æ—¢æ»¡è¶³åŸºæœ¬éœ€æ±‚ï¼Œåˆèƒ½é€‚åº”ç”Ÿäº§ç¯å¢ƒçš„å¤æ‚è¦æ±‚ï¼ŒåŒæ—¶ä¿æŒä»£ç çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚\næ€»ç»“\nåœºæ™¯æ¯”è¾ƒç®€å•ï¼šç›´æ¥ä½¿ç”¨åŸºç¡€ç‰ˆå³å¯\nåœºæ™¯ç›¸å¯¹å¤æ‚ï¼šå¯è€ƒè™‘ä½¿ç”¨ FastAPI Router åˆ†å‰²æ¨¡å—\néœ€è¦æ ¡éªŒ Header éœ€ï¼Œæ·»åŠ  APIKey çš„ä¿æŠ¤ï¼šä½¿ç”¨ APIKeyHeader ä¸­é—´ä»¶ä¿æŠ¤æ¥å£\nä¸ºäº†æ–¹ä¾¿è¿ç»´å’Œç›‘æ§ï¼šé›†æˆ Prometheus å¹¶æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯ç­‰å…ƒæ•°æ®\n\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.159-fastapiä¸­æ•°æ®åº“éš”ç¦»çº§åˆ«çš„é…ç½®çš„ä½¿ç”¨","url":"/2025/09/15/No-159-fastapi%E4%B8%AD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E7%9A%84%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BD%BF%E7%94%A8/","content":"å¯¼è¯»åœ¨åšä¸€æ¬¡æ•°æ®åº“æ’å…¥æ•°æ®çš„æ—¶å€™ï¼Œå‘ç°é‡å¤æ’å…¥é—®é¢˜ï¼Œç»è¿‡æ’æŸ¥å‘ç°æ˜¯å¹¶å‘å¯¼è‡´ã€‚äºæ˜¯å¼€å§‹æ’æŸ¥åŸå› ã€‚\né—®é¢˜åŸå› æ’æŸ¥ç»è¿‡é‡‡ç”¨åˆ†å¸ƒå¼é”ä½¿ç”¨äº†åˆ†å¸ƒå¼é”å¯¹æ“ä½œæ•°æ®åº“é€»è¾‘è¿›è¡Œäº†åŠ é”ï¼Œä½†æ˜¯å‘ç°è¿˜æ˜¯ä¼šæœ‰é‡å¤æ’å…¥é—®é¢˜ã€‚\nå‘ç°æ¯æ¬¡æ’å…¥æ•°æ®å‰éƒ½ä¼šæŸ¥è¯¢ä¸€æ¬¡æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰å°±æ’å…¥ï¼Œæœ‰å°±è·³è¿‡ã€‚\næ·»åŠ è°ƒè¯•æ—¥å¿—åŠ äº†é”è¿˜æ˜¯ä¸èƒ½è§£å†³é—®é¢˜ã€‚äºæ˜¯å°†æ“ä½œæ•°æ®åº“å‰åçš„æ—¥å¿—æ‰“å°å‡ºæ¥ã€‚\nå‘ç°å½“ä¸¤ä¸ªè¯·æ±‚åŒæ—¶æŸ¥è¯¢å’Œæ’å…¥çš„æ—¶å€™ï¼Œæ˜æ˜å·²ç»åŠ é”äº†ï¼Œä½†æ˜¯æ•°æ®æ’å…¥æ²¡æˆåŠŸï¼Œè™½ç„¶æ¯æ¬¡è¯·æ±‚éƒ½æ˜¾å¼è¿›è¡Œäº† commit æ“ä½œã€‚\næ‰€ä»¥ç»“æœå°±æ˜¯ï¼Œä¸¤ä¸ªè¯·æ±‚éƒ½æŸ¥è¯¢äº†æ•°æ®åº“ï¼Œå‘ç°æ²¡æœ‰æ•°æ®ï¼Œç„¶åéƒ½æ’å…¥äº†æ•°æ®ï¼Œå¯¼è‡´é‡å¤æ’å…¥ã€‚\nè§£å†³æ–¹æ¡ˆç»è¿‡ä¸€ç•ªæœç´¢ï¼Œå‘ç°ï¼šå¦‚æœä½ ç”¨çš„æ•°æ®åº“ï¼ˆæ¯”å¦‚ MySQL é»˜è®¤ InnoDBï¼‰ï¼Œäº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯ REPEATABLE READã€‚çº¿ç¨‹ A æ’å…¥å¹¶æäº¤ï¼Œçº¿ç¨‹ B åœ¨æ’å…¥å‰å°±å¼€å¯äº†äº‹åŠ¡ï¼Œé‚£ä¹ˆå®ƒçš„å¿«ç…§è¿˜æ˜¯æ—§çš„ï¼Œå¯¼è‡´æŸ¥ä¸åˆ°æœ€æ–°æäº¤çš„æ•°æ®ã€‚\næ‰€ä»¥ï¼Œè§£å†³æ–¹æ¡ˆå°±æ˜¯ï¼šå°†æ•°æ®åº“éš”ç¦»çº§åˆ«æ”¹ä¸º READ COMMITTEDã€‚\nå…·ä½“ fastapi ä¸­æ“ä½œåœ¨åˆ›å»ºæ•°æ®åº“å¼•æ“çš„æ—¶å€™ï¼Œæ·»åŠ  isolation_level=&quot;READ COMMITTED&quot; å‚æ•°å³å¯ã€‚\nfrom sqlmodel import Session, create_enginefrom settings import settingsengine_o_db_ex_&lt;db_name&gt; = create_engine(    str(settings.DB_O_DB_EX_&lt;DB_NAME&gt;_URI),    pool_recycle=300,    pool_pre_ping=True,    pool_size=10,  # è¿æ¥æ± å¤§å°    max_overflow=20,  # æº¢å‡ºè¿æ¥æ•°    isolation_level=&quot;READ COMMITTED&quot;, # è®¾ç½®éš”ç¦»çº§åˆ«)def get_db_o_ex_&lt;db_name&gt;() -&gt; Generator[Session, None, None]:    try:        with Session(engine_o_db_ex_&lt;db_name&gt;) as session:            yield session    except SQLAlchemyError as e:        # å¯é€‰æ‹©åŠ å…¥æ—¥å¿—è®°å½•æˆ–é”™è¯¯ä¸ŠæŠ¥        logger.exception(f&quot;Error occurred while managing session: &#123;e&#125;&quot;)        raiseDBExSessionDep = Annotated[Session, Depends(get_db_o_ex_&lt;db_name&gt;)]\n\nå†ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æ–¹å¼ï¼Œç»Ÿä¸€è·å– Session å¯¹è±¡ï¼Œè¿™æ ·åœ¨è·¨ Session çš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥é¿å…é‡å¤æ’å…¥äº†ã€‚\næ€»ç»“æ•°æ®åº“éš”ç¦»çº§åˆ«ï¼Œè¿™ä¸ªå‚æ•°åœ¨å¹³æ—¶å¼€å‘ä¸­ï¼Œå¾ˆå°‘ç”¨åˆ°ï¼Œä½†æ˜¯å½“é‡åˆ°å¹¶å‘é—®é¢˜çš„æ—¶å€™ï¼Œè¿™ä¸ªå‚æ•°å°±æ´¾ä¸Šç”¨åœºäº†ã€‚\né‡åˆ°é—®é¢˜ï¼Œä¸è¦æ…Œï¼Œå…ˆæ’æŸ¥åŸå› ï¼Œå¯ä»¥ä½¿ç”¨ debug æ¨¡å¼ï¼Œæ‰“å°æ—¥å¿—ï¼Œä¸€æ­¥æ­¥æ’æŸ¥ã€‚\nMySQL æ”¯æŒä»¥ä¸‹éš”ç¦»çº§åˆ«ï¼ˆSQLAlchemy é‡Œå­—ç¬¦ä¸²è¦å†™å…¨å¤§å†™ï¼‰ï¼š\n\nâ€œREAD UNCOMMITTEDâ€\nâ€œREAD COMMITTEDâ€ âœ… æ¨èï¼Œèƒ½çœ‹åˆ°åˆ«çš„äº‹åŠ¡å·²æäº¤çš„æ•°æ®\nâ€œREPEATABLE READâ€ ï¼ˆMySQL é»˜è®¤ï¼Œå¯èƒ½å¯¼è‡´ä½ æŸ¥ä¸åˆ°åˆšæäº¤çš„æ•°æ®ï¼‰\nâ€œSERIALIZABLEâ€\n\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.161-fastapiä¸­åˆ†å¸ƒå¼é”çš„ä½¿ç”¨","url":"/2025/09/28/No-161-fastapi%E4%B8%AD%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E4%BD%BF%E7%94%A8/","content":"ğŸš€ FastAPI ä¸­åˆ†å¸ƒå¼é”çš„ä½¿ç”¨ï¼šä»ä¸€æ¬¡â€œåº“å­˜è¶…å–â€è¯´èµ·å»å¹´åŒ 11ï¼Œæˆ‘æ¥åˆ°ä¸€ä¸ªä¸´æ—¶éœ€æ±‚ï¼šæŸä¸ªç”µå•†é¡¹ç›®è¦åœ¨ FastAPI å¾®æœåŠ¡ä¸­æ¥å…¥ä¸€ä¸ªé™æ—¶ç§’æ€æ´»åŠ¨ã€‚å¬èµ·æ¥å¾ˆç®€å•ï¼šä¸‹å•æ—¶ï¼Œå…ˆæ‰£å‡åº“å­˜ï¼Œå†ç”Ÿæˆè®¢å•ã€‚\nä½†æ´»åŠ¨åˆšå¼€å§‹ 5 åˆ†é’Ÿï¼Œæµ‹è¯•ç¯å¢ƒé‡Œå°±å‡ºç°äº†åº“å­˜è¢«è¶…å–çš„é—®é¢˜ã€‚\næˆ‘ä¸€è„¸é—®å·ï¼š\n\nâ€œä¸æ˜¯åŠ äº†æ•°æ®åº“è¡Œçº§é”å—ï¼Ÿæ€ä¹ˆè¿˜ä¼šè¶…å–ï¼Ÿâ€\n\nåæ¥æ’æŸ¥å‘ç°ï¼š\n\nFastAPI éƒ¨ç½²åœ¨ å¤šå®ä¾‹ + å¤šè¿›ç¨‹ æ¨¡å¼ä¸‹ã€‚\nè¯·æ±‚å¹¶å‘æ‰“åˆ°ä¸åŒèŠ‚ç‚¹ï¼Œå•æœºé”æ ¹æœ¬æ²¡æ³•æ§åˆ¶å…¨å±€å¹¶å‘ã€‚\nå¯¼è‡´åº“å­˜è¿˜æ²¡åˆ·æ–°ï¼Œå¦ä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿä»¥ä¸ºè¿˜èƒ½ä¹°ã€‚\n\nè¿™æ—¶ï¼Œæˆ‘ä»¬æ‰æ„è¯†åˆ°ï¼šğŸ‘‰ éœ€è¦ä¸€æŠŠåˆ†å¸ƒå¼é”ã€‚\n\nğŸ”‘ ä¸ºä»€ä¹ˆè¦åˆ†å¸ƒå¼é”ï¼Ÿå¸¸è§åœºæ™¯ï¼š\n\nç§’æ€&#x2F;æŠ¢è´­ï¼šé˜²æ­¢åº“å­˜è¢«å¤šå‡\nä»»åŠ¡è°ƒåº¦ï¼šé¿å…å¤šä¸ªå‰¯æœ¬åŒæ—¶è·‘åŒä¸€ä¸ªä»»åŠ¡\næ¥å£å¹‚ç­‰ï¼šé˜²æ­¢é‡å¤è¯·æ±‚é€ æˆæ•°æ®é‡å¤å†™å…¥\n\nåœ¨ å•æœºç¯å¢ƒ ä¸‹ï¼Œthreading.Lock å°±å¤Ÿäº†ã€‚ä½†åœ¨ åˆ†å¸ƒå¼ç¯å¢ƒï¼ˆKubernetes &#x2F; å¤šå‰¯æœ¬éƒ¨ç½²ï¼‰ä¸‹ï¼Œå¿…é¡»è¦é  Redis è¿™ç§ ä¸­å¿ƒåŒ–å­˜å‚¨ æ¥åè°ƒã€‚\n\nğŸ§© åˆ†å¸ƒå¼é”çš„åŸç†åˆ†å¸ƒå¼é”çš„åŸºæœ¬åŸç†å¾ˆç®€å•ï¼š\n\nåŠ é”ï¼šå°è¯•åœ¨ Redis è®¾ç½®ä¸€ä¸ª Keyï¼ˆåªå…è®¸ç¬¬ä¸€ä¸ªå†™å…¥æˆåŠŸï¼‰ã€‚\næ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼šæ‰§è¡Œåº“å­˜æ‰£å‡ã€æŠ¥è¡¨ç”Ÿæˆç­‰ã€‚\nè§£é”ï¼šæ‰§è¡Œå®Œååˆ é™¤ Keyï¼Œä½†è¦æ³¨æ„ä¸èƒ½è¯¯åˆ åˆ«äººçš„é”ã€‚\n\nRedis çš„ SETNX + è¿‡æœŸæ—¶é—´ï¼ˆEXPIREï¼‰å°±èƒ½å®ç°è¿™ä¸€è¿‡ç¨‹ã€‚\n\nâš¡ åœ¨ FastAPI ä¸­çš„å®æˆ˜ç¤ºä¾‹ä¸‹é¢åˆ†äº«ä¸€ä¸ªçœŸå®çš„ä¸šåŠ¡æ”¹é€ æ¡ˆä¾‹ï¼š\nfrom contextlib import contextmanagerfrom redis import Redisfrom redis.lock import Lockimport logginglogger = logging.getLogger(__name__)redis_client = Redis(host=&quot;127.0.0.1&quot;, port=6379, decode_responses=True)@contextmanagerdef get_redis_lock(lock_key: str, timeout: int = 10):    &quot;&quot;&quot;    è·å– Redis åˆ†å¸ƒå¼é”ï¼ˆä¸Šä¸‹æ–‡ç®¡ç†å™¨æ–¹å¼ï¼‰    Args:        lock_key (str): é”çš„ key        timeout (int, optional): è¿‡æœŸæ—¶é—´ï¼Œç§’. Defaults to 10.    &quot;&quot;&quot;    lock = Lock(        redis=redis_client,        name=lock_key,        timeout=timeout,        blocking_timeout=timeout + 5,    )    acquired = False    try:        acquired = lock.acquire(blocking=True)        if not acquired:            raise Exception(f&quot;[get_redis_lock] Failed to acquire lock: &#123;lock_key&#125;&quot;)        yield lock    finally:        if acquired:            try:                lock.release()                logger.info(f&quot;[get_redis_lock] Released lock: &#123;lock_key&#125;&quot;)            except Exception as e:                logger.warning(f&quot;Lock release error: &#123;e&#125;&quot;)\n\nè°ƒç”¨æ—¶éå¸¸ä¼˜é›…ï¼š\n@app.post(&quot;/seckill&quot;)def seckill():    with get_redis_lock(&quot;lock:inventory&quot;, timeout=5):        stock = int(redis_client.get(&quot;stock&quot;) or 0)        if stock &lt;= 0:            raise HTTPException(status_code=400, detail=&quot;åº“å­˜ä¸è¶³&quot;)        redis_client.decr(&quot;stock&quot;)        return &#123;&quot;msg&quot;: &quot;ç§’æ€æˆåŠŸ&quot;&#125;\n\nğŸ‘‰ æœ‰äº† withï¼Œå³ä½¿ä»£ç æŠ›å¼‚å¸¸ï¼Œä¹Ÿèƒ½ä¿è¯é”è¢«æ­£ç¡®é‡Šæ”¾ã€‚\n\nğŸ§ª å¤šå‰¯æœ¬ + å¤šçº¿ç¨‹è„šæœ¬åœºæ™¯åˆ†å¸ƒå¼é”ä¸ä»…èƒ½ä¿æŠ¤æ¥å£ï¼Œè¿˜èƒ½ç”¨åœ¨ åå°å®šæ—¶ä»»åŠ¡ã€‚\næ¯”å¦‚ï¼šå¤šä¸ª FastAPI å‰¯æœ¬åŒæ—¶å¯åŠ¨äº†ä¸€ä¸ªå®šæ—¶è„šæœ¬å»ç”ŸæˆæŠ¥è¡¨ï¼Œå¦‚æœæ²¡åŠ é”ï¼Œç»“æœå°±æ˜¯â€”â€”æ¯ä¸ªå‰¯æœ¬éƒ½ç”Ÿæˆä¸€æ¬¡æŠ¥è¡¨ï¼Œæµªè´¹èµ„æºè¿˜å¯èƒ½äº§ç”Ÿé‡å¤æ•°æ®ã€‚\næœ‰äº† get_redis_lockï¼š\nasync def generate_report():    with get_redis_lock(&quot;lock:report&quot;, timeout=30):        print(&quot;å¼€å§‹ç”ŸæˆæŠ¥è¡¨...&quot;)        await asyncio.sleep(5)  # æ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡        print(&quot;æŠ¥è¡¨ç”Ÿæˆå®Œæˆ âœ…&quot;)\n\nè¿™ä¹Ÿé€‚ç”¨äºå¤šå‰¯æœ¬çš„æ¶ˆè´¹è€…è„šæœ¬åœºæ™¯ï¼šä¾‹å¦‚é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œå¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶å‘æ•°æ®åº“æ’å…¥æ•°æ®ï¼Œè™½ç„¶æ’å…¥ä¹‹å‰éƒ½ä¼šè¿›è¡Œæ£€æŸ¥æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œä½†è¿˜æ˜¯ä¼šå‡ºç°é‡å¤æ•°æ®ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°åˆ†å¸ƒå¼é”æ¥ä¿è¯æ•°æ®çš„å”¯ä¸€æ€§ã€‚\nå³ä½¿éƒ¨ç½²äº†å¤šä¸ªå‰¯æœ¬ï¼Œä¹Ÿåªæœ‰ä¸€ä¸ªå®ä¾‹èƒ½æ‹¿åˆ°é”æ‰§è¡Œï¼Œé¿å…é‡å¤ä»»åŠ¡ã€‚\n\nâš ï¸ è¸©å‘ä¸ä¼˜åŒ–\né”è¿‡æœŸæ—¶é—´å¤ªçŸ­\n\nä¸šåŠ¡æ²¡æ‰§è¡Œå®Œï¼Œé”å°±è¿‡æœŸï¼Œå…¶ä»–å®ä¾‹è¿›æ¥é‡å¤æ‰§è¡Œã€‚\nâœ… è§£å†³ï¼šåŠ â€œé”ç»­æœŸâ€ï¼ˆçœ‹é—¨ç‹—ï¼‰ã€‚\n\n\né”è¿‡æœŸæ—¶é—´å¤ªé•¿\n\næœåŠ¡å®•æœºåé”è¿Ÿè¿Ÿä¸é‡Šæ”¾ï¼Œå½±å“å¯ç”¨æ€§ã€‚\n\n\né«˜å¹¶å‘ä¸‹é”å†²çªä¸¥é‡\n\nå¯ä»¥ç»“åˆ æ¶ˆæ¯é˜Ÿåˆ— æ¥å‰Šå³°å¡«è°·ã€‚\n\n\n\n\nğŸ æ€»ç»“é‚£æ¬¡â€œåº“å­˜è¶…å–â€äº‹æ•…åï¼Œæˆ‘å¯¹åˆ†å¸ƒå¼é”æœ‰äº†æ›´æ·±çš„è®¤è¯†ï¼š\n\nåœ¨ å•æœºæ—¶ä»£ï¼Œthreading.Lock è¶³å¤Ÿã€‚\nåœ¨ åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼ŒRedis åˆ†å¸ƒå¼é”æ˜¯æœ€å¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚\nåœ¨ FastAPI é¡¹ç›®é‡Œï¼Œé…åˆ @contextmanager å†™æ³•ï¼Œèƒ½è®©é”çš„è·å–ä¸é‡Šæ”¾æ›´å®‰å…¨ã€ä¼˜é›…ã€‚\n\nä¸€å¥è¯ï¼š\n\nåˆ†å¸ƒå¼é”ä¸æ˜¯é“¶å¼¹ï¼Œä½†åœ¨å…³é”®åœºæ™¯ä¸‹ï¼Œå®ƒæ˜¯æ•‘å‘½ç¨»è‰ã€‚\n\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.160-fastapiä¸­è¯·æ±‚å”¯ä¸€æ ‡è¯†çš„ä½¿ç”¨","url":"/2025/09/26/No-160-fastapi%E4%B8%AD%E8%AF%B7%E6%B1%82%E5%94%AF%E4%B8%80%E6%A0%87%E8%AF%86%E7%9A%84%E4%BD%BF%E7%94%A8/","content":"å¯¼è¯»åœ¨é¡¹ç›®æ’æŸ¥é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œé“¾è·¯è·Ÿè¸ªæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ‰‹æ®µï¼Œé€šè¿‡é“¾è·¯è·Ÿè¸ªï¼Œå¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜ï¼Œä»è€Œå¿«é€Ÿè§£å†³é—®é¢˜ã€‚\nä½†æ˜¯å½“æ²¡æœ‰é“¾è·¯è·Ÿè¸ªçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¯·æ±‚å”¯ä¸€æ ‡è¯†ï¼Œæ¥è¿½è¸ªå½“å‰é¡¹ç›®è¯·æ±‚æ—¥å¿—ï¼Œä»è€Œå®šä½é—®é¢˜ã€‚\nè‡³å°‘åœ¨æœ¬é¡¹ç›®ä¸­èƒ½ä¸€æ¬¡æ€§å…¨éƒ¨æœç´¢å‡ºæ¥å½“å‰è¯·æ±‚çš„æ—¥å¿—ï¼Œå¿«é€ŸæŸ¥çœ‹è¿è¡Œé€»è¾‘æ˜¯å¦æ­£ç¡®ã€‚\nfastapi ä¸­è¯·æ±‚å”¯ä¸€æ ‡è¯†çš„ä½¿ç”¨æ·»åŠ ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå°†è¯·æ±‚çš„å”¯ä¸€æ ‡è¯†æ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­ã€‚\nimport loggingfrom starlette.middleware.base import BaseHTTPMiddlewarefrom fastapi import Requestimport uuidfrom app.core.logger import loggerfrom app.core.logger import request_id_ctxclass RequestIDMiddleware(BaseHTTPMiddleware):    async def dispatch(self, request: Request, call_next):        # è·å–æˆ–ç”Ÿæˆè¯·æ±‚ID        request_id = request.headers.get(&#x27;X-Request-ID&#x27;) or str(uuid.uuid4())        request.state.request_id = request_id                # è®¾ç½®ä¸Šä¸‹æ–‡å˜é‡        token = request_id_ctx.set(request_id)                try:            logger.info(f&quot;Request started: &#123;request.method&#125; &#123;request.url&#125;&quot;)            response = await call_next(request)            response.headers[&#x27;X-Request-ID&#x27;] = request_id            logger.info(f&quot;Request completed: &#123;request.method&#125; &#123;request.url&#125; &#123;response.status_code&#125;&quot;)            return response        except Exception as e:            logger.error(f&quot;Request failed: &#123;request.method&#125; &#123;request.url&#125; &#123;str(e)&#125;&quot;)            raise        finally:            request_id_ctx.reset(token)\n\nä¸»ç¨‹åºä¸­æ·»åŠ ä¸­é—´ä»¶app = FastAPI(    title=settings.PROJECT_NAME,    openapi_url=f&quot;/openapi.json&quot;,    generate_unique_id_function=custom_generate_unique_id,)# è¯·æ±‚IDä¸­é—´ä»¶app.add_middleware(RequestIDMiddleware)\n\næ—¥å¿—ä¸­æ·»åŠ è¯·æ±‚IDimport loggingfrom concurrent_log_handler import ConcurrentRotatingFileHandlerfrom app.core.config import settingsfrom contextvars import ContextVar# åˆ›å»ºä¸Šä¸‹æ–‡å˜é‡å­˜å‚¨è¯·æ±‚IDrequest_id_ctx = ContextVar(&quot;request_id&quot;, default=None)class RequestIDFilter(logging.Filter):    def filter(self, record):        # ä»å½“å‰è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­è·å–è¯·æ±‚ID        record.request_id = request_id_ctx.get() or &quot;no-request-id&quot;        return True\n\nè®¾ç½®æ—¥å¿—æ ¼å¼# è®¾ç½®æ—¥å¿—çš„æ ¼å¼ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹formatter = logging.Formatter(    &quot;%(asctime)s &quot;    &quot;%(filename)s:%(lineno)d &quot;    &quot;%(processName)s &quot;    &quot;%(threadName)s &quot;    &quot;%(levelname)s &quot;    &quot;%(request_id)s &quot;    &quot;%(message)s&quot;)\n\næ·»åŠ æ—¥å¿—å¤„ç†å™¨logger.addFilter(RequestIDFilter())\n\nä½¿ç”¨logger.info(&quot;This is an info message with request ID&quot;)\n\nåœ¨æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°è¯·æ±‚ID:\n2025-09-19 18:33:00,354 middleware.py:22 MainProcess Thread-1 (run_blocking_portal) INFO 870b229f-1546-4147-873a-f3763b548db7 Request completed: POST http://testserver/coding_callback_manager/issue_status_change_first/1.0.0 5002025-09-19 18:33:54,885 middleware.py:19 MainProcess Thread-1 (run_blocking_portal) INFO f8cf2dfc-79ff-43dc-a384-f4a51c3f52c0 Request started: POST http://testserver/coding_callback_manager/issue_status_change_first/1.0.0\n\nåœ¨è¿”å›è¯·æ±‚å¤´ä¸­ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°è¯·æ±‚ID:\nContent-Type: application/jsonContent-Length: 66Connection: closeServer: openrestyDate: Thu, 25 Sep 2025 17:11:44 GMTX-Proxy-By: Gin Reverse ProxyX-Request-Id: 3ab700b0-b818-4d22-8e91-671ea46317e2\n\næ€»ç»“\né€šè¿‡è¯·æ±‚å”¯ä¸€æ ‡è¯†ï¼Œå¯ä»¥å¿«é€Ÿå®šä½è¯·æ±‚çš„é“¾è·¯ï¼Œä»è€Œå®šä½é—®é¢˜ã€‚\né€šè¿‡è¯·æ±‚å”¯ä¸€æ ‡è¯†èƒ½å¿«é€Ÿæœç´¢å‡ºæ¥å½“å‰è¯·æ±‚çš„æ—¥å¿—ã€‚\nå¯ä»¥ä»è¿”å›è¯·æ±‚å¤´ä¸­æ‹¿åˆ°è¯·æ±‚IDï¼Œå†å»æœç´¢æ—¥å¿—ã€‚\nå¯ä»¥é€šè¿‡è¯·æ±‚å”¯ä¸€ idï¼ŒæŸ¥è¯¢åˆ°è¯·æ±‚å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ï¼Œåˆ†æè¯·æ±‚è€—æ—¶ã€‚\nå¯ä»¥é€šè¿‡é€æ­¥æ‰“å°æ—¥å¿—ï¼Œæ¥åˆ†æè¯·æ±‚çš„æµç¨‹ï¼Œåˆ†ææ€§èƒ½ç“¶é¢ˆã€‚\n\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.153-fastapiä¸­ä½¿ç”¨redis-poolè¿æ¥æ± ","url":"/2025/08/12/No-153-fastapi%E4%B8%AD%E4%BD%BF%E7%94%A8redispool%E8%BF%9E%E6%8E%A5%E6%B1%A0/","content":"å¯¼è¯»åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸ºäº†æå‡æ¥å£æ€§èƒ½ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé€‰æ‹©ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± ã€redis è¿æ¥æ± ç­‰ã€‚\né€šè¿‡è¿æ¥æ± è¿æ¥ï¼Œæå‡æ•ˆç‡ï¼ŒèŠ‚çœå†…å­˜å¼€é”€ã€‚åŒæ—¶é€šè¿‡å°†æ•°æ®ç¼“å­˜åˆ° redis ä¸­ï¼Œè¿˜å¯ä»¥å‡å°‘ç½‘ç»œ IO å¼€é”€ã€‚\né€šå¸¸ä¸€ä¸ªæ¥å£ç›´æ¥è·Ÿæ•°æ®åº“äº¤äº’ï¼Œä¾‹å¦‚ MySQLï¼Œå“åº”æ—¶é—´å¤§æ¦‚åœ¨ 200ms ~ 500ms å·¦å³ã€‚åŠ ä¸Š redis ç¼“å­˜ä¹‹åï¼Œæ¥å£ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–ï¼Œå“åº”æ—¶é—´å¯ä»¥ç¼©çŸ­åˆ° 10ms å·¦å³ï¼Œå¯ä»¥è¯´æ˜¯è´¨çš„é£è·ƒã€‚\nä¸‹é¢å°†ä»‹ç»å¦‚ä½•åœ¨ FastAPI ä¸­ä½¿ç”¨ redis è¿æ¥æ± ã€‚\n1ã€å®‰è£…åº“é¦–å…ˆç¡®ä¿å®‰è£…äº†å¿…è¦çš„ Python åŒ…ï¼š\npip install fastapi redis uvicorn\n\n2. æ·»åŠ é…ç½®åœ¨æ ¹ç›®å½•ä¸‹ï¼Œæ·»åŠ  .env.dev æ–‡ä»¶ï¼Œé‡Œé¢æ˜¯é¡¹ç›®ç›¸å…³é…ç½®ã€‚\nREDIS_HOST=&quot;192.168.201.200&quot;REDIS_PORT=&quot;6379&quot;REDIS_PASSWORD=&quot;&lt;PASSWORD&gt;&quot;REDIS_DB=&quot;9&quot;\n\nåœ¨ config.py æ–‡ä»¶ä¸­ï¼Œå¢åŠ å¦‚ä¸‹ä»£ç ï¼Œè¯»å–é…ç½®ä¿¡æ¯ã€‚\nimport osfrom typing import Annotated, Anyfrom pydantic import (    AnyUrl,    BeforeValidator,    PostgresDsn,    computed_field,)from pydantic_core import MultiHostUrlfrom pydantic_settings import BaseSettings, SettingsConfigDictclass Settings(BaseSettings):    if os.getenv(&quot;APP_ENV&quot;) == &quot;development&quot; or not os.getenv(&quot;APP_ENV&quot;):            model_config = SettingsConfigDict(                env_file=&quot;.env.dev&quot;, env_ignore_empty=True, extra=&quot;ignore&quot;            )    if os.getenv(&quot;APP_ENV&quot;) == &quot;production&quot;:        model_config = SettingsConfigDict(            env_file=&quot;/app/.env.production&quot;, env_ignore_empty=True, extra=&quot;ignore&quot;        )    if os.getenv(&quot;APP_ENV&quot;) == &quot;test&quot;:        model_config = SettingsConfigDict(            env_file=&quot;.env.test&quot;, env_ignore_empty=True, extra=&quot;ignore&quot;        )    REDIS_HOST: str    REDIS_PORT: int     REDIS_PASSWD: str     REDIS_DB: intsettings = Settings()\n\n3. æ·»åŠ  redis è¿æ¥æ± åœ¨ db.py ä¸­ï¼Œåˆ›å»º redis è¿æ¥æ± ã€‚\nfrom config import settingsimport redisfrom fastapi import Depends# åˆ›å»º Redis è¿æ¥æ± redis_pool = redis.ConnectionPool(    host=settings.REDIS_HOST,    port=settings.REDIS_PORT,    db=settings.REDIS_DB,    decode_responses=True,  # è‡ªåŠ¨è§£ç è¿”å›çš„å­—èŠ‚ä¸ºå­—ç¬¦ä¸²    max_connections=10     # æœ€å¤§è¿æ¥æ•°)\n\n4. åˆ›å»ºdepsåœ¨ deps.py æ–‡ä»¶ä¸­ï¼Œå®šä¹‰ä¸€ä¸ªä¾èµ–é¡¹ã€‚\nimport redisfrom logger import loggerdef get_redis():    &quot;&quot;&quot;è·å– Redis è¿æ¥çš„ä¾èµ–å‡½æ•°&quot;&quot;&quot;    try:        redis_conn = redis.Redis(connection_pool=redis_pool)        yield redis_conn    except Exception as e:        # å¯é€‰æ‹©åŠ å…¥æ—¥å¿—è®°å½•æˆ–é”™è¯¯ä¸ŠæŠ¥        logger.exception(f&quot;Error occurred while managing redis pool session: &#123;e&#125;&quot;)        raise    finally:        # è¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨å…³é—­è¿æ¥ï¼Œè¿æ¥ä¼šè¿”å›åˆ°è¿æ¥æ± ä¸­        passRedisPoolDep = Annotated[Redis, Depends(get_redis)]\n\n5. ä½¿ç”¨ RedisPoolDep ä¾èµ–é¡¹åœ¨ä½ çš„ä¸»åº”ç”¨æ–‡ä»¶ï¼ˆå¦‚ main.pyï¼‰ä¸­ä½¿ç”¨è¿™ä¸ªè¿æ¥æ± ï¼š\nfrom fastapi import FastAPI, Dependsfrom deps import RedisPoolDepimport redisapp = FastAPI()@app.get(&quot;/set/&#123;key&#125;/&#123;value&#125;&quot;)async def set_key_value(    key: str,     value: str,     redis_conn: RedisPoolDep):    &quot;&quot;&quot;è®¾ç½®é”®å€¼å¯¹&quot;&quot;&quot;    redis_conn.set(key, value)    return &#123;&quot;message&quot;: f&quot;Set &#123;key&#125; = &#123;value&#125;&quot;&#125;@app.get(&quot;/get/&#123;key&#125;&quot;)async def get_key(    key: str,     redis_conn: RedisPoolDep):    &quot;&quot;&quot;è·å–é”®å€¼&quot;&quot;&quot;    value = redis_conn.get(key)    return &#123;&quot;key&quot;: key, &quot;value&quot;: value&#125;@app.get(&quot;/info&quot;)async def redis_info(redis_conn: RedisPoolDep):    &quot;&quot;&quot;è·å– Redis æœåŠ¡å™¨ä¿¡æ¯&quot;&quot;&quot;    info = redis_conn.info()    return &#123;&quot;redis_info&quot;: info&#125;\n\næ€»ç»“\nåˆ›å»º Redis è¿æ¥æ± å¹¶åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–\nåˆ›å»ºä¾èµ–å‡½æ•° get_redis() æ¥è·å–è¿æ¥\nåœ¨è·¯ç”±å¤„ç†å‡½æ•°ä¸­ä½¿ç”¨ Depends(get_redis) æ³¨å…¥ Redis è¿æ¥\nå¯¹äºæ›´å¤æ‚çš„åº”ç”¨ï¼Œå°†ä¸šåŠ¡é€»è¾‘å°è£…åˆ°æœåŠ¡å±‚\nè€ƒè™‘ä½¿ç”¨å¼‚æ­¥ Redis å®¢æˆ·ç«¯ä»¥æé«˜æ€§èƒ½, ä¾‹å¦‚ aioredisã€‚è¿™é‡Œæœ‰å‘ï¼Œæ…ç”¨ã€‚ã€‚ã€‚\nä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†é…ç½®\n\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.157-fastapiä¸­å¦‚ä½•ç”Ÿæˆswaggeræ–‡æ¡£","url":"/2025/08/25/No-157-fastapi%E4%B8%AD%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90swagger%E6%96%87%E6%A1%A3/","content":"å¯¼è¯»fastapi é¡¹ç›®å¼€å§‹äº†ï¼Œæ€ä¹ˆå¿«é€Ÿå®šä¹‰ swagger æ–‡æ¡£ï¼Œä¾›æµ‹è¯•ã€å‰ç«¯æŸ¥çœ‹å‘¢ï¼Ÿæœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ fastapi ç”Ÿæˆ swagger æ–‡æ¡£ã€‚\nç”Ÿæˆswaggeræ–‡æ¡£å…¶å®ï¼Œfastapi æœ¬èº«å°±æ”¯æŒç”Ÿæˆ swagger æ–‡æ¡£ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ uvicorn å¯åŠ¨é¡¹ç›®æ—¶ï¼Œåªéœ€è¦åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ http://127.0.0.1:8000/docs å³å¯çœ‹åˆ° swagger æ–‡æ¡£ã€‚\nç”Ÿæˆæ–‡æ¡£éå¸¸ç®€å•ï¼Œä½†æ˜¯æ ‡å‡†åŒ–çš„æ–‡æ¡£æ¯”è¾ƒéš¾ï¼Œå¾€å¾€éœ€è¦é¢„å®šå¥½ä¸€äº›è§„åˆ™ï¼Œæ¯”å¦‚å‚æ•°çš„ç±»å‹ã€å‚æ•°çš„æè¿°ã€å‚æ•°çš„é»˜è®¤å€¼ç­‰ã€‚å¦‚æœè¿™äº›è§„åˆ™æ²¡æœ‰ç»Ÿä¸€ï¼Œé‚£ä¹ˆç”Ÿæˆçš„æ–‡æ¡£å°†éå¸¸æ··ä¹±ï¼Œéš¾ä»¥é˜…è¯»ã€‚\nå¹¸å¥½ï¼Œfastapi æä¾›äº† pydantic æ¨¡å—ï¼Œæ—¢èƒ½ç”¨æ¥æ ¡éªŒæ¥å£çš„è¾“å…¥å’Œè¾“å‡ºï¼Œåˆèƒ½ç”¨æ¥ç”Ÿæˆ swagger æ–‡æ¡£ã€‚\npydanticä½¿ç”¨å¯ä»¥å‚è€ƒ No.148-fastapiä¸­ä½¿ç”¨æ ‡å‡†åŒ–å‡ºå…¥å‚è‡ªåŠ¨åŒ–ç”Ÿæˆæ¥å£æ–‡æ¡£ã€‚\nç”Ÿæˆæ–‡æ¡£ç›´æ¥è®¿é—® http://127.0.0.1:8000/docs å³å¯çœ‹åˆ° swagger æ–‡æ¡£ã€‚\nä½†æ˜¯å½“æˆ‘ä»¬éœ€è¦å°†æ–‡æ¡£å¯¼å…¥åˆ°ç¬¬ä¸‰æ–¹å¹³å°çš„æ—¶å€™ï¼Œæ¯”å¦‚ postmanï¼Œå°±éœ€è¦å°†æ–‡æ¡£å¯¼å‡ºä¸º json æ ¼å¼ã€‚\nå¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå¿«é€Ÿç”Ÿæˆ json æ ¼å¼çš„æ–‡æ¡£æ–‡ä»¶ï¼š\n# å¯åŠ¨é¡¹ç›®fastapi dev --port 9000 --reload# ç”Ÿæˆæ–‡æ¡£curl -X GET http://127.0.0.1:9000/openapi.json &gt; docs/api/swagger.json\n\nç”Ÿæˆçš„æ–‡æ¡£å°†åœ¨ docs/api/swagger.json æ–‡ä»¶ä¸­ã€‚å†æ‰‹åŠ¨å¯¼å…¥åˆ°ç›¸å…³å¹³å°å³å¯ã€‚æˆ–è€…ä½¿ç”¨ openAPI ç¼–å†™è„šæœ¬è‡ªåŠ¨åŒ–å¯¼å…¥ã€‚\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.158-å½“æˆ‘å¼ƒç”¨pycharmæ”¹ç”¨vscodeä¹‹å","url":"/2025/09/01/No-158-%E5%BD%93%E6%88%91%E5%BC%83%E7%94%A8pycharm%E6%94%B9%E7%94%A8vscode%E4%B9%8B%E5%90%8E/","content":"å¯¼è¯»ä½œä¸ºä¸€åPythonå¼€å‘è€…ï¼Œæˆ‘ä½¿ç”¨PyCharmå·²ç»è¶…è¿‡äº”å¹´äº†ã€‚å®ƒæ— ç–‘æ˜¯ä¸€æ¬¾å¼ºå¤§çš„IDEï¼Œæ™ºèƒ½æç¤ºã€è°ƒè¯•åŠŸèƒ½ã€é¡¹ç›®å¯¼èˆªéƒ½æ— å¯æŒ‘å‰”ã€‚ä½†éšç€æ—¶é—´çš„æ¨ç§»ï¼Œä¸€äº›ä¸é€‚å¼€å§‹æµ®ç°ï¼š\nå†…å­˜å ç”¨æƒŠäººï¼šæ‰“å¼€å¤§å‹é¡¹ç›®æ—¶ï¼ŒPyCharmåŠ¨ä¸åŠ¨å°±åƒæ‰4GB+å†…å­˜ï¼Œæˆ‘çš„16GBç¬”è®°æœ¬å¼€å§‹æ‰è¥Ÿè§è‚˜ã€‚å°¤å…¶æ˜¯ä½¿ç”¨AI æ’ä»¶åï¼Œå†…å­˜å ç”¨æ›´æ˜¯é£™å‡ã€‚ä»£ç è¡¥å…¨æ˜¾å¾—å¾ˆå¡é¡¿ï¼Œä¸¥é‡å½±å“ç¼–ç ä½“éªŒã€‚è€Œä¸”æˆ‘ 256GB çš„ SSD ç¡¬ç›˜ä¹Ÿåƒä¸æ¶ˆäº†ã€‚\nå¯åŠ¨é€Ÿåº¦æ…¢ï¼šä»ç‚¹å‡»å›¾æ ‡åˆ°çœŸæ­£å¼€å§‹ç¼–ç ï¼Œç­‰å¾…æ—¶é—´æ¯”è¾ƒä¹…ï¼Œæ‰“å¼€ Pycharmï¼Œä¸€èˆ¬è¦å»ä¸ªå«ç”Ÿé—´å†å›æ¥å¼€å§‹å·¥ä½œä¼šæ¯”è¾ƒé¡ºç•…ã€‚\nè¿‡äºâ€œé‡é‡çº§â€ï¼šæœ‰æ—¶å€™æˆ‘åªæ˜¯æƒ³å¿«é€Ÿç¼–è¾‘ä¸€ä¸ªå°è„šæœ¬ï¼Œå´éœ€è¦å¯åŠ¨æ•´ä¸ªIDEã€‚å•ä¸ªæ–‡ä»¶ç¼–è¾‘ï¼Œå…¶å® sublime text 3 å°±è¶³å¤Ÿäº†ã€‚\nå°è¯•è½¬å˜ï¼šåˆä½“éªŒVSCodeä¸€å¼€å§‹æˆ‘æ˜¯æ€€ç–‘çš„â€”â€”ä¸€ä¸ªâ€œç¼–è¾‘å™¨â€çœŸèƒ½æ›¿ä»£â€œIDEâ€å—ï¼Ÿ\nå®‰è£…å¿…è¦çš„Pythonæ‰©å±•åï¼Œæˆ‘æƒŠè®¶åœ°å‘ç°VSCodeæä¾›äº†ç»å¤§å¤šæ•°æˆ‘éœ€è¦çš„åŠŸèƒ½ï¼š\n\næ™ºèƒ½æç¤ºï¼šé€šè¿‡Pylanceæ‰©å±•ï¼Œä»£ç è¡¥å…¨å‡ ä¹ä¸è¾“PyCharm\nè°ƒè¯•æ”¯æŒï¼šå®Œæ•´çš„æ–­ç‚¹è°ƒè¯•ã€å˜é‡ç›‘è§†åŠŸèƒ½\nè™šæ‹Ÿç¯å¢ƒæ”¯æŒï¼šè½»æ¾åˆ‡æ¢ä¸åŒPythonè§£é‡Šå™¨\nGité›†æˆï¼šæºä»£ç ç®¡ç†ç›´è§‚æ˜“ç”¨\n\nç»äº†ç»äº†ã€‚\næˆ‘ä¹Ÿæ˜¯å°è¯•äº†å¾ˆå¤šæ¬¡ï¼Œåˆ‡æ¢åˆ°VSCodeåï¼Œæ„Ÿè§‰ä¸é¡ºå†åˆ‡æ¢å›æ¥ã€‚\nè¿™æ ·å°è¯•äº† 7ï½8 æ¬¡ï¼Œæˆ‘ç»ˆäºå†³å®šå½»åº•æŠ›å¼ƒPyCharmï¼Œæ‹¥æŠ±VSCodeã€‚\næƒŠå–œå‘ç°ï¼šVSCodeçš„ç‹¬ç‰¹ä¼˜åŠ¿ä½¿ç”¨å‡ å‘¨åï¼Œæˆ‘å‘ç°äº†VSCodeè®¸å¤šä»¤äººæ¬£å–œçš„ç‰¹ç‚¹ï¼š\né—ªç”µèˆ¬çš„å¯åŠ¨é€Ÿåº¦ï¼šå‡ ä¹ç¬é—´å¯åŠ¨ï¼Œéšæ—¶è®°å½•çµæ„Ÿä¸å†æ˜¯é—®é¢˜\nå†…å­˜å‹å¥½ï¼šé€šå¸¸å†…å­˜å ç”¨åªæœ‰PyCharmçš„1&#x2F;3åˆ°1&#x2F;2\næ— ç¼å¤šè¯­è¨€æ”¯æŒï¼šå‰ç«¯é¡¹ç›®å¸¸å¸¸éœ€è¦åŒæ—¶å¤„ç†Pythonã€JavaScriptã€HTMLï¼ŒVSCodeå¤©ç”Ÿå°±æ˜¯å¤šè¯­è¨€ç¯å¢ƒ\næ‰©å±•ç”Ÿæ€ä¸°å¯Œï¼šå‡ ä¹ä»»ä½•éœ€æ±‚éƒ½èƒ½æ‰¾åˆ°å¯¹åº”çš„æ‰©å±•ï¼Œä¸”å®‰è£…ç®¡ç†æå…¶ç®€å•\né«˜åº¦å¯å®šåˆ¶ï¼šé€šè¿‡settings.jsonå¯ä»¥ç²¾ç»†è°ƒæ•´æ¯ä¸€ä¸ªç»†èŠ‚\né€‚åº”æŒ‘æˆ˜ï¼šéœ€è¦å…‹æœçš„éšœç¢è½¬å˜å¹¶éä¸€å¸†é£é¡ºï¼Œç¡®å®æœ‰ä¸€äº›éœ€è¦é€‚åº”çš„åœ°æ–¹ï¼š\né¡¹ç›®ç®¡ç†æ–¹å¼ä¸åŒï¼šVSCodeä»¥æ–‡ä»¶å¤¹ä¸ºåŸºç¡€è€Œä¸æ˜¯â€œé¡¹ç›®â€æ¦‚å¿µï¼Œéœ€è¦æ—¶é—´é€‚åº”\néƒ¨åˆ†é«˜çº§åŠŸèƒ½éœ€è¦é…ç½®ï¼šä¸€äº›PyCharmå¼€ç®±å³ç”¨çš„åŠŸèƒ½ï¼Œåœ¨VSCodeä¸­éœ€è¦é¢å¤–è®¾ç½®\né‡æ„å·¥å…·ç•¥é€Šä¸€ç­¹ï¼šè™½ç„¶å¯ç”¨ï¼Œä½†PyCharmçš„é‡æ„å·¥å…·ç¡®å®æ›´å¼ºå¤§\næˆ‘çš„VSCode Pythonå¼€å‘é…ç½®ç»è¿‡ä¸æ–­è°ƒæ•´ï¼Œè¿™æ˜¯æˆ‘çš„é»„é‡‘é…ç½®ï¼š\n&#123;  &quot;python.linting.pylintEnabled&quot;: true,  &quot;python.linting.enabled&quot;: true,  &quot;python.formatting.provider&quot;: &quot;black&quot;,  &quot;editor.formatOnSave&quot;: true,  &quot;python.linting.pylintArgs&quot;: [&quot;--load-plugins&quot;, &quot;pylint_django&quot;],  &quot;python.linting.flake8Enabled&quot;: false,  &quot;[python]&quot;: &#123;    &quot;editor.defaultFormatter&quot;: &quot;ms-python.python&quot;,    &quot;editor.tabSize&quot;: 4  &#125;&#125;\n\nå¿…å¤‡æ‰©å±•ï¼š\n\nPython (Microsoft)\nPylance\nJupyter\nPython Docstring Generator\nBlack Formatter\nMagicPython\nPython Debug (Microsoft)\n\nç»“è®ºï¼šé€‚åˆçš„æ‰æ˜¯æœ€å¥½çš„ç»è¿‡å‡ ä¸ªæœˆçš„ä½¿ç”¨ï¼Œæˆ‘ç¡®å®šVSCodeå·²ç»æ»¡è¶³äº†æˆ‘95%çš„Pythonå¼€å‘éœ€æ±‚ã€‚å‰©ä¸‹çš„5%ä¸»è¦æ˜¯è¶…å¤§å‹é¡¹ç›®çš„é‡æ„å’Œæ·±åº¦æ•°æ®åº“é›†æˆï¼Œè¿™äº›åœºæ™¯ä¸‹æˆ‘ä»ç„¶ä¼šæ‰“å¼€PyCharmã€‚\né€‚åˆVSCodeçš„åœºæ™¯ï¼š\n\nWebå¼€å‘ï¼ˆå°¤å…¶æ˜¯å…¨æ ˆå¼€å‘ï¼‰\næ•°æ®ç§‘å­¦å’Œè„šæœ¬ç¼–å†™\nå¿«é€Ÿç¼–è¾‘å’Œè½»é‡çº§é¡¹ç›®\néœ€è¦é¢‘ç¹åˆ‡æ¢è¯­è¨€çš„é¡¹ç›®\n\nå¯èƒ½ä»éœ€PyCharmçš„åœºæ™¯ï¼š\n\nè¶…å¤§å‹é¡¹ç›®å¯¼èˆªå’Œé‡æ„\nå¤æ‚çš„æ•°æ®åº“é›†æˆå¼€å‘\néœ€è¦IDEçº§æ·±åº¦é›†æˆçš„ä¼ä¸šç¯å¢ƒ\n\nè½¬å˜ç¼–è¾‘å™¨ä¸æ˜¯éæ­¤å³å½¼çš„é€‰æ‹©ï¼Œè€Œæ˜¯æ‰¾åˆ°æœ€é€‚åˆè‡ªå·±å·¥ä½œæµç¨‹çš„å·¥å…·ã€‚å¯¹æˆ‘æ¥è¯´ï¼ŒVSCodeæä¾›äº†æ›´å¥½çš„å¹³è¡¡ç‚¹ï¼šæ—¢å¼ºå¤§åˆçµæ´»ï¼Œæ—¢åŠŸèƒ½ä¸°å¯Œåˆä¿æŒè½»é‡ã€‚\nä¹Ÿè®¸æœ‰ä¸€å¤©æˆ‘ä¼šå†æ¬¡æ”¹å˜æˆ‘çš„å·¥å…·é€‰æ‹©ï¼Œä½†è‡³å°‘ç°åœ¨ï¼ŒVSCodeè®©æˆ‘äº«å—ç¼–ç çš„ä¹è¶£å˜å¾—æ›´åŠ ç®€å•ç›´æ¥ã€‚\nå®‰åˆ©ä¸€æ³¢ï¼šVSCode çš„æœç´¢åŠŸèƒ½æ˜¯çœŸçš„å¥½ç”¨ã€‚\n\nä½ æœ‰ç±»ä¼¼çš„å·¥å…·è½¬å˜ç»å†å—ï¼Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„æ•…äº‹ï¼\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["fastapi"]},{"title":"No.162-fastapiä¸­ä½¿ç”¨ celery.backend_cleanup çš„å·¥ä½œåŸç†","url":"/2025/10/31/No-162-fastapi%E4%B8%AD%E4%BD%BF%E7%94%A8celery.backend_cleanup%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/","content":"å¯¼è¯»FastApi ä¸­ä½¿ç”¨å®šæ—¶ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡ï¼Œé¦–é€‰ Celeryã€‚åœ¨å¯åŠ¨ Celery Beat çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨åˆå§‹åŒ–ä¸€ä¸ª celery.backend_cleanup ä»»åŠ¡ã€‚é‚£ä¹ˆè¿™ä¸ªä»»åŠ¡åšäº†å“ªäº›äº‹æƒ…å‘¢ï¼Ÿå·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆä½¿ç”¨å’Œé…ç½®å‘¢ï¼Ÿ\nä½œç”¨å®ƒçš„ä½œç”¨ï¼š\n\néå† result backendï¼›\næ‰¾å‡ºè¶…è¿‡ result_expires æ—¶é—´çš„ä»»åŠ¡ç»“æœï¼›\nå°†å…¶åˆ é™¤ã€‚\n\nå…³é”®é…ç½®é¡¹ï¼š\n\n\n\né…ç½®é¡¹\nè¯´æ˜\nç¤ºä¾‹\n\n\n\nresult_expires\nä»»åŠ¡ç»“æœä¿å­˜çš„è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰\napp.conf.result_expires = 3600ï¼ˆ1å°æ—¶ï¼‰\n\n\nresult_backend\nå­˜å‚¨ä»»åŠ¡ç»“æœçš„åç«¯\nredis://localhost:6379/0\n\n\nresult_backend_cleanup_intervalï¼ˆCelery 5.3+ï¼‰\næ¸…ç†ä»»åŠ¡è¿è¡Œé—´éš”\napp.conf.result_backend_cleanup_interval = 3600\n\n\nä¸¾ä¾‹é…ç½®ï¼š\napp.conf.update(    result_backend=&quot;redis://localhost:6379/0&quot;,    result_expires=3600,  # ä¸€å°æ—¶ï¼Œéå¸¸é‡è¦ï¼Œå®ƒå†³å®šäº†ä½ çš„ä»»åŠ¡è·‘å®Œå­˜å‚¨çš„æ—¶é•¿)\n\nå‘½ä»¤è¡Œè§¦å‘ï¼š\ncelery -A your_project call celery.backend_cleanup\n\npythonè°ƒç”¨ï¼š\nfrom celery import Celeryapp = Celery(&#x27;your_project&#x27;)app.send_task(&#x27;celery.backend_cleanup&#x27;)\n\nå¦‚æœä½ ç”¨çš„ Beat scheduler ä¸ºæ•°æ®åº“ï¼Œåˆ™ä¼šåˆ›å»ºä¸€æ¡å®šæ—¶ä»»åŠ¡æ•°æ®ï¼Œé€šå¸¸æ˜¯ 0 4 * * *ï¼Œè¡¨ç¤ºåœ¨æ¯å¤©çš„å‡Œæ™¨ 4 ç‚¹æ‰§è¡Œã€‚\næ³¨æ„äº‹é¡¹ï¼š\n\nå¦‚æœä½ å…³é—­äº† result_persistent&#x3D;False æˆ–æ ¹æœ¬æ²¡ç”¨ backendï¼ˆæ¯”å¦‚åª fire-and-forgetï¼‰ï¼Œåˆ™æ— éœ€å…³å¿ƒã€‚\nå¦‚æœä½ ç”¨çš„æ˜¯ æ•°æ®åº“ ä½œä¸º backendï¼ˆå¦‚ Django ORMã€SQLAlchemyï¼‰ï¼Œæ¸…ç†æ˜¯åˆ é™¤æ•°æ®åº“è®°å½•ï¼›\nå¦‚æœä½ ç”¨çš„æ˜¯ Redisï¼Œåˆ™æ¸…ç†æ˜¯åˆ é™¤å¯¹åº”çš„ keyï¼›\nå¯¹äºè‡ªå®šä¹‰ backendï¼Œå¿…é¡»å®ç° cleanup() æ–¹æ³•ï¼Œå¦åˆ™è¯¥ä»»åŠ¡æ— æ•ˆã€‚\n\nå·¥ä½œåŸç†\né¦–å…ˆåˆ¤æ–­ç»“æœæ•°æ®æ˜¯å¦è¿‡æœŸ\nå†æ ¹æ®ç­›é€‰å‡ºæ¥çš„è¿‡æœŸæ•°æ®ï¼Œè¿›è¡Œåˆ é™¤\n\nåˆ¤æ–­è¿‡æœŸæ•°æ®çš„é€»è¾‘ï¼šCelery é€šè¿‡æ¯”è¾ƒ ä»»åŠ¡ç»“æœçš„å­˜å‚¨æ—¶é—´ + result_expires æ¥åˆ¤æ–­æ˜¯å¦è¿‡æœŸã€‚ç®€åŒ–é€»è¾‘å¦‚ä¸‹ï¼š\nif now() - date_done &gt; result_expires:    # ä»»åŠ¡ç»“æœå·²è¿‡æœŸï¼Œåˆ é™¤\n\nä¸åŒ Backend çš„åˆ¤æ–­æ–¹å¼ï¼š\n\n\n\nBackend ç±»å‹\nè¿‡æœŸåˆ¤æ–­æ–¹å¼\nè¯´æ˜\n\n\n\nRedis &#x2F; Memcached\nåˆ©ç”¨ key çš„ TTLï¼ˆè¿‡æœŸæ—¶é—´ï¼‰\nCelery åœ¨å†™å…¥ç»“æœæ—¶ä¼šè®¾ç½® EXPIREï¼ŒRedis è‡ªåŠ¨æ¸…é™¤\n\n\nDatabaseï¼ˆå¦‚ Django ORMã€SQLAlchemyï¼‰\nè¯»å– date_done å­—æ®µï¼Œå¯¹æ¯”å½“å‰æ—¶é—´\nCelery å®šæœŸæ‰§è¡Œ DELETE FROM celery_taskmeta WHERE date_done &lt; now() - result_expires\n\n\nRPC &#x2F; AMQP\nä¸æŒä¹…åŒ–ç»“æœæˆ–è‡ªåŠ¨è¿‡æœŸ\nä¸€èˆ¬ä¸éœ€æ¸…ç†\n\n\nFilesystem &#x2F; S3 ç­‰æŒä¹…åŒ–å­˜å‚¨\næ£€æŸ¥ä¿å­˜æ–‡ä»¶çš„æ—¶é—´æˆ³\næ¯”å¯¹ mtime æˆ– metadata\n\n\nCelery.backend_cleanup\nè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®\nCelery å®šæœŸæ‰§è¡Œ backend_cleanupï¼Œæ¸…ç†è¿‡æœŸæ•°æ®\n\n\nä»¥æ•°æ®åº“ backend ä¸ºä¾‹ï¼šåœ¨ Celery çš„æºç ä¸­ï¼ˆcelery&#x2F;backends&#x2F;database&#x2F;init.pyï¼‰ï¼ŒDatabaseBackend æœ‰ä¸€ä¸ª cleanup() æ–¹æ³•ï¼š\ndef cleanup(self):    session = self.ResultSession()    now = self.app.now()    expired = now - self.expires    session.query(TaskModel).filter(TaskModel.date_done &lt; expired).delete()    session.commit()\n\nè¿‡æœŸæ•°æ®å¸¸è§çš„å­˜å‚¨æ–¹å¼ï¼š\n\n\n\nBackend\nå­˜å‚¨ä½ç½®\nç¤ºä¾‹\n\n\n\nRedis\nRedis çš„ key-value\nkey ç±»ä¼¼äº celery-task-meta-&lt;uuid&gt;\n\n\nDatabaseï¼ˆDjango ORM &#x2F; SQLAlchemyï¼‰\næ•°æ®åº“è¡¨ä¸­ï¼ˆé»˜è®¤è¡¨åï¼šcelery_taskmetaï¼‰\nåˆ—ï¼šid, task_id, status, result, date_done, traceback\n\n\nAMQP (RabbitMQ)\næ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸æŒä¹…åŒ–\nä»»åŠ¡å®Œæˆåå³æ¶ˆè´¹\n\n\nFilesystem\næ–‡ä»¶ç³»ç»Ÿçš„ç»“æœæ–‡ä»¶\næ¯ä¸ªä»»åŠ¡ç»“æœå•ç‹¬å­˜æ–‡ä»¶\n\n\nCache backend (memcached)\nç¼“å­˜ä¸­\nè‡ªåŠ¨è¿‡æœŸ\n\n\nS3 &#x2F; HTTP\nè¿œç¨‹å¯¹è±¡å­˜å‚¨\nå¸¦ metadata æ ‡è¯†æ—¶é—´æˆ³\n\n\né…ç½®å’Œä½¿ç”¨è¦ä½¿ç”¨å®ƒï¼Œéœ€è¦åœ¨ celery é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š\n# celeryconfig.pyCELERY_RESULT_BACKEND = &#x27;redis://localhost:6379/0&#x27;CELERY_RESULT_EXPIRES = 3600  # 1 hour   è¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ï¼Œå­˜å‚¨å¤Ÿå°æ—¶å°±åˆ é™¤CELERY_RESULT_CLEANUP_INTERVAL = 60  # 1 minuteï¼Œæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡æ¸…ç†ä»»åŠ¡ï¼Œè¿‡æœŸä»»åŠ¡ä¼šè¢«è‡ªåŠ¨åˆ é™¤\n\n\næ¯æ—¥è¸©ä¸€å‘ï¼Œç”Ÿæ´»æ›´è½»æ¾ã€‚\næœ¬æœŸåˆ†äº«å°±åˆ°è¿™é‡Œå•¦ï¼Œç¥å›åœ¨æµ‹å¼€ä¹‹è·¯ä¸Šè¶Šèµ°è¶Šé¡ºï¼Œè¶Šèµ°è¶Šè¿œã€‚\n","tags":["Celery"]}]